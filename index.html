<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://yandex.ru/games/sdk/v2"></script>
    <title>–ö–∏–±–µ—Ä –ö–æ—Ç: –ü–æ–ª—ë—Ç</title>
    <style>
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            margin: 0;
            padding: 0;
            width: 100vw;
            height: 100dvh; 
            background: #0d001a; 
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            font-family: 'Courier New', Courier, monospace;
            user-select: none;
            -webkit-user-select: none;
            -webkit-touch-callout: none;
            touch-action: none;
        }

        #game-wrapper {
            position: relative;
            width: 100%; 
            height: 100%;
            max-width: 60vh; 
            overflow: hidden;
            background: #000;
        }

        canvas {
            display: block;
            width: 100%;
            height: 100%;
            object-fit: contain; 
            background: linear-gradient(180deg, #0d001a 0%, #000033 100%);
        }

        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
        }

        /* === HEADER BUTTONS === */
        #top-bar {
            position: absolute;
            top: 12px;
            right: 12px;
            display: flex;
            gap: 8px;
            pointer-events: auto;
            z-index: 100;
        }

        .icon-btn {
            width: 44px;
            height: 44px;
            background: rgba(0, 15, 30, 0.85);
            border: 1.5px solid #0ff;
            color: #0ff;
            font-size: 18px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            border-radius: 10px;
            transition: all 0.15s;
        }

        .icon-btn:active {
            background: #0ff;
            color: #000;
            transform: scale(0.9);
        }

        .icon-btn.muted {
            border-color: #ff0055;
            color: #ff0055;
        }

        .icon-btn svg {
            width: 20px;
            height: 20px;
        }

        #btn-settings-open {
            position: absolute;
            top: 12px;
            left: 12px;
            pointer-events: auto;
            z-index: 100;
        }

        /* === SCREENS === */
        .screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(8px);
            pointer-events: auto;
            transition: opacity 0.25s;
            z-index: 15;
            padding: 20px;
            gap: 12px;
        }

        .screen.hidden {
            opacity: 0;
            pointer-events: none;
        }

        /* === TYPOGRAPHY === */
        .title-main {
            color: #0ff;
            font-size: 32px;
            font-weight: bold;
            margin: 0;
            text-shadow: 0 0 20px #0ff;
            text-align: center;
            line-height: 1.15;
            letter-spacing: 2px;
        }

        .title-section {
            color: #0ff;
            font-size: 22px;
            font-weight: bold;
            margin: 0;
            text-shadow: 0 0 15px #0ff;
            text-align: center;
        }

        .title-failed {
            color: #ff0055;
            font-size: 26px;
            font-weight: bold;
            margin: 0 0 8px 0;
            text-shadow: 0 0 15px #ff0055;
            text-align: center;
            line-height: 1.15;
        }

        .title-paused {
            color: #FFFF00;
            font-size: 26px;
            font-weight: bold;
            text-shadow: 0 0 15px #FFFF00;
            text-align: center;
            margin-bottom: 15px;
        }

        .label {
            color: #888;
            font-size: 10px;
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        .hint {
            color: #666;
            font-size: 11px;
            margin-top: 8px;
        }

        /* === BUTTONS === */
        .btn {
            background: rgba(0, 20, 40, 0.9);
            border: 1.5px solid #0ff;
            color: #0ff;
            padding: 14px 28px;
            font-family: inherit;
            font-size: 13px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.15s;
            min-width: 160px;
        }

        .btn:active {
            background: #0ff;
            color: #000;
            transform: scale(0.96);
        }

        .btn-primary {
            background: linear-gradient(180deg, rgba(0,255,255,0.2) 0%, rgba(0,255,255,0.05) 100%);
            box-shadow: 0 0 20px rgba(0,255,255,0.2);
        }

        .btn-danger {
            border-color: #ff0055;
            color: #ff0055;
        }
        .btn-danger:active {
            background: #ff0055;
            color: #000;
        }

        .btn-success {
            border-color: #00ff88;
            color: #00ff88;
        }
        .btn-success:active {
            background: #00ff88;
            color: #000;
        }

        .btn-warning {
            border-color: #FFFF00;
            color: #FFFF00;
        }
        .btn-warning:active {
            background: #FFFF00;
            color: #000;
        }

        .btn-purple {
            border-color: #c0f;
            color: #c0f;
        }
        .btn-purple:active {
            background: #c0f;
            color: #000;
        }

        .btn-ghost {
            border-color: #555;
            color: #888;
            background: rgba(0,0,0,0.5);
        }
        .btn-ghost:active {
            background: #555;
            color: #000;
        }

        .btn-disabled {
            border-color: #333 !important;
            color: #555 !important;
            background: rgba(30,30,30,0.5) !important;
            cursor: default;
        }

        .btn-small {
            padding: 10px 20px;
            font-size: 11px;
            min-width: 120px;
        }

        .ad-tag {
            font-size: 9px;
            opacity: 0.6;
            margin-left: 6px;
            font-weight: normal;
        }

        /* === CARD === */
        .card {
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid rgba(0,255,255,0.3);
            border-radius: 16px;
            padding: 20px 25px;
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 85%;
            max-width: 280px;
        }

        .card-danger {
            border-color: rgba(255,0,85,0.3);
        }

        /* === SCORE DISPLAY === */
        .score-big {
            font-size: 52px;
            color: #fff;
            font-weight: bold;
            margin: 5px 0 12px 0;
            text-shadow: 0 0 20px rgba(255,255,255,0.3);
            line-height: 1;
        }

        .best-row {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255,255,255,0.08);
            padding: 6px 14px;
            border-radius: 20px;
        }

        .best-row span:first-child {
            color: #0ff;
            font-size: 12px;
            font-weight: bold;
        }

        .best-row span:last-child {
            color: #fff;
            font-size: 12px;
        }

        /* === SHOP === */
        #shop-screen {
            padding: 60px 15px 20px 15px;
            justify-content: flex-start;
            gap: 10px;
        }

        .shop-header {
            text-align: center;
            margin-bottom: 5px;
        }

        .shop-credits {
            color: #FFFF00;
            font-size: 14px;
            font-weight: bold;
            margin-top: 6px;
        }

        .shop-preview {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
        }

        .preview-box {
            width: 130px;
            height: 150px;
            background: rgba(0,0,0,0.8);
            border: 1.5px solid #444;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 12px;
        }

        #shopCanvas {
            width: 100px;
            height: 100px;
        }

        .skin-name {
            color: #fff;
            font-size: 11px;
            margin-top: 8px;
            text-align: center;
            font-weight: bold;
        }

        .arrow-btn {
            width: 44px;
            height: 44px;
            background: rgba(0, 20, 40, 0.9);
            border: 1.5px solid #0ff;
            color: #0ff;
            font-size: 18px;
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: 0.15s;
        }

        .arrow-btn:active {
            transform: scale(0.9);
            background: #0ff;
            color: #000;
        }

        .shop-actions {
            display: flex;
            flex-direction: column;
            gap: 8px;
            width: 100%;
            max-width: 200px;
            align-items: center;
        }

        .shop-actions .btn {
            width: 100%;
            padding: 12px 20px;
        }

        /* === SETTINGS === */
        .settings-card {
            width: 85%;
            max-width: 260px;
        }

        .lang-group {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            width: 100%;
        }

        .btn-lang {
            flex: 1;
            padding: 10px;
            border: 1px solid #444;
            background: rgba(0, 0, 0, 0.5);
            color: #666;
            cursor: pointer;
            font-family: inherit;
            font-size: 11px;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .btn-lang.active {
            border-color: #0ff;
            background: rgba(0, 255, 255, 0.15);
            color: #0ff;
        }

        /* === HUD === */
        #hud {
            position: absolute;
            top: 12%;
            width: 100%;
            text-align: center;
            pointer-events: none;
        }

        #score-display {
            font-size: 48px;
            color: rgba(255, 255, 255, 0.85);
            font-weight: bold;
            text-shadow: 0 2px 10px rgba(0,0,0,0.5);
        }

        /* === BUTTON GROUPS === */
        .btn-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            width: 100%;
            max-width: 200px;
            align-items: center;
        }

        .btn-group .btn {
            width: 100%;
        }

        /* === ORIENTATION WARNING === */
        #orientation-warning {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            z-index: 9999;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: #0ff;
            font-size: 16px;
            text-align: center;
            padding: 30px;
        }
        
        #orientation-warning svg {
            width: 50px;
            height: 50px;
            margin-bottom: 20px;
            animation: rotate-phone 2s infinite ease-in-out;
        }
        
        @keyframes rotate-phone {
            0%, 100% { transform: rotate(0deg); }
            50% { transform: rotate(-90deg); }
        }

        @media (orientation: landscape) {
            body.mobile-device #orientation-warning {
                display: flex;
            }
        }

        /* === RESPONSIVE === */
        @media (max-height: 550px) {
            .title-main { font-size: 26px; }
            .title-section { font-size: 18px; }
            .title-failed { font-size: 22px; }
            .score-big { font-size: 42px; }
            .btn { padding: 11px 22px; font-size: 12px; }
            .card { padding: 15px 20px; }
            .preview-box { width: 110px; height: 130px; }
            #shopCanvas { width: 80px; height: 80px; }
            #score-display { font-size: 40px; }
        }

        @media (max-height: 450px) {
            .screen { gap: 8px; padding: 15px; }
            .title-main { font-size: 22px; }
            .score-big { font-size: 36px; }
            .btn { padding: 9px 18px; font-size: 11px; min-width: 140px; }
            .btn-group { gap: 6px; }
        }
    </style>
</head>
<body>

<div id="orientation-warning">
    <svg viewBox="0 0 24 24" fill="currentColor">
        <path d="M17 1.01L7 1c-1.1 0-2 .9-2 2v18c0 1.1.9 2 2 2h10c1.1 0 2-.9 2-2V3c0-1.1-.9-1.99-2-1.99zM17 19H7V5h10v14z"/>
    </svg>
    <div>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–µ—Ä–µ–≤–µ—Ä–Ω–∏—Ç–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ<br><br>Please rotate your device</div>
</div>

<div id="game-wrapper">
    <canvas id="gameCanvas"></canvas>

    <div id="ui-layer">
        
        <div id="top-bar">
            <button id="btn-toggle-sound" class="icon-btn">üîä</button>
            <button id="btn-toggle-pause" class="icon-btn" style="display: none;">
                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
            </button>
        </div>

        <button id="btn-settings-open" class="icon-btn">‚öôÔ∏è</button>

        <div id="hud" class="hidden">
            <div id="score-display">0</div>
        </div>

        <!-- START -->
        <div id="start-screen" class="screen">
            <h1 class="title-main" id="txt-title">CYBER<br>CAT</h1>
            <button class="btn btn-primary" id="btn-start">START</button>
            <button class="btn btn-purple btn-small" id="btn-shop-open">SHOP</button>
            <div class="hint" id="txt-tap">TAP TO FLY</div>
        </div>
        
        <!-- SHOP -->
        <div id="shop-screen" class="screen hidden">
            <div class="shop-header">
                <h2 class="title-section" id="txt-shop-title">SHOP</h2>
                <div class="shop-credits" id="shop-credits">0</div>
            </div>
            
            <div class="shop-preview">
                <button class="arrow-btn" id="btn-shop-prev">‚óÄ</button>
                <div class="preview-box">
                    <canvas id="shopCanvas" width="100" height="100"></canvas>
                    <div class="skin-name" id="shop-skin-name">CYBER CAT</div>
                </div>
                <button class="arrow-btn" id="btn-shop-next">‚ñ∂</button>
            </div>

            <div class="shop-actions">
                <button class="btn" id="btn-shop-select">SELECT</button>
                <button class="btn btn-success btn-small" id="btn-shop-free-credits">üì∫ +100</button>
                <button class="btn btn-ghost btn-small" id="btn-shop-back">BACK</button>
            </div>
        </div>

        <!-- PAUSE -->
        <div id="pause-screen" class="screen hidden">
            <div class="title-paused" id="txt-paused">PAUSED</div>
            <div class="btn-group">
                <button class="btn btn-warning" id="btn-resume">RESUME</button>
                <button class="btn btn-ghost btn-small" id="btn-pause-menu">MENU</button>
            </div>
        </div>

        <!-- GAMEOVER -->
        <div id="gameover-screen" class="screen hidden">
            <div class="card card-danger">
                <div class="title-failed" id="txt-failed">GAME OVER</div>
                <div class="label" id="txt-score-label">SCORE</div>
                <div class="score-big" id="final-score">0</div>
                <div class="best-row">
                    <span id="txt-best-label">BEST:</span>
                    <span id="best-score">0</span>
                </div>
            </div>

            <div class="btn-group" style="margin-top: 5px;">
                <button class="btn btn-success" id="btn-revive" style="display: none;">
                    üì∫ REVIVE<span class="ad-tag">(Ad)</span>
                </button>
                <button class="btn btn-danger" id="btn-restart">RETRY</button>
                <button class="btn btn-ghost btn-small" id="btn-gameover-menu">MENU</button>
            </div>
        </div>

        <!-- SETTINGS -->
        <div id="settings-screen" class="screen hidden">
            <div class="card settings-card">
                <div class="title-section" id="txt-settings-title" style="margin-bottom: 15px;">SETTINGS</div>
                <div class="label" id="txt-lang-label">LANGUAGE</div>
                <div class="lang-group">
                    <button class="btn-lang" id="btn-lang-en">EN</button>
                    <button class="btn-lang" id="btn-lang-ru">RU</button>
                </div>
            </div>
            <button class="btn btn-ghost btn-small" id="btn-settings-back" style="margin-top: 10px;">BACK</button>
        </div>

    </div>
</div>

<script>
var ysdk = null;

const SKINS = [
    { id: 0, nameKey: 'skin_0', price: 0, color: '#00FFFF', flame: '#FFFF00', eyeColor: '#fff', jetpackColor: '#FFFF00', bodyColor: '#000' },
    { id: 1, nameKey: 'skin_1', price: 100, color: '#FF00FF', flame: '#ff66ff', eyeColor: '#0ff', jetpackColor: '#800080', bodyColor: '#1a001a' },
    { id: 2, nameKey: 'skin_2', price: 250, color: '#00FFFF', flame: '#e0ffff', eyeColor: '#0088ff', jetpackColor: '#C0C0C0', bodyColor: '#FFFFFF' },
    { id: 3, nameKey: 'skin_3', price: 500, color: '#FF4500', flame: '#FF4500', eyeColor: '#fff', jetpackColor: '#FF0000', bodyColor: '#110000' },
    { id: 4, nameKey: 'skin_4', price: 1000, color: '#FFD700', flame: '#ffffff', eyeColor: '#fff', jetpackColor: '#DAA520', bodyColor: '#000' }
];

const TRANSLATIONS = {
    'en': {
        'title': 'CYBER<br>CAT',
        'tap': 'TAP TO FLY',
        'start': 'START',
        'paused': 'PAUSED',
        'resume': 'RESUME',
        'failed': 'GAME OVER',
        'score_label': 'SCORE',
        'best_label': 'BEST:',
        'retry': 'RETRY',
        'revive_btn': 'üì∫ REVIVE<span class="ad-tag">(Ad)</span>',
        'settings_title': 'SETTINGS',
        'lang_label': 'LANGUAGE',
        'back': 'BACK',
        'menu_btn': 'MENU',
        'shop': 'SHOP',
        'shop_title': 'SHOP',
        'select': 'SELECT',
        'selected': 'EQUIPPED',
        'buy': 'BUY',
        'credits': 'CREDITS',
        'free_credits': 'üì∫ +100',
        'skin_0': 'CYBER CAT',
        'skin_1': 'NEON CAT',
        'skin_2': 'WHITE CAT',
        'skin_3': 'INFERNO CAT',
        'skin_4': 'GOLDEN CAT'
    },
    'ru': {
        'title': '–ö–ò–ë–ï–†<br>–ö–û–¢',
        'tap': '–ù–ê–ñ–ú–ò –ß–¢–û–ë–´ –õ–ï–¢–ï–¢–¨',
        'start': '–°–¢–ê–†–¢',
        'paused': '–ü–ê–£–ó–ê',
        'resume': '–ü–†–û–î–û–õ–ñ–ò–¢–¨',
        'failed': '–ö–û–ù–ï–¶ –ò–ì–†–´',
        'score_label': '–°–ß–Å–¢',
        'best_label': '–õ–£–ß–®–ò–ô:',
        'retry': '–ó–ê–ù–û–í–û',
        'revive_btn': 'üì∫ –°–ü–ê–°–¢–ò<span class="ad-tag">(–†–µ–∫–ª–∞–º–∞)</span>',
        'settings_title': '–ù–ê–°–¢–†–û–ô–ö–ò',
        'lang_label': '–Ø–ó–´–ö',
        'back': '–ù–ê–ó–ê–î',
        'menu_btn': '–ú–ï–ù–Æ',
        'shop': '–ú–ê–ì–ê–ó–ò–ù',
        'shop_title': '–ú–ê–ì–ê–ó–ò–ù',
        'select': '–í–´–ë–†–ê–¢–¨',
        'selected': '–í–´–ë–†–ê–ù–û',
        'buy': '–ö–£–ü–ò–¢–¨',
        'credits': '–ö–†–ï–î–ò–¢–´',
        'free_credits': 'üì∫ +100',
        'skin_0': '–ö–ò–ë–ï–† –ö–û–¢',
        'skin_1': '–ù–ï–û–ù –ö–û–¢',
        'skin_2': '–ë–ï–õ–´–ô –ö–û–¢',
        'skin_3': '–ò–ù–§–ï–†–ù–û –ö–û–¢',
        'skin_4': '–ó–û–õ–û–¢–û–ô –ö–û–¢'
    }
};

class LanguageManager {
    constructor() {
        this.currentLang = 'en';
        this.init();
    }

    init() {
        if (window.ysdk?.environment?.i18n?.lang) {
            this.currentLang = window.ysdk.environment.i18n.lang;
        } else {
            const userLang = navigator.language || navigator.userLanguage; 
            if (userLang) this.currentLang = userLang.substr(0, 2);
        }
        this.currentLang = ['ru', 'be', 'kk', 'uk', 'uz'].includes(this.currentLang) ? 'ru' : 'en';
        this.updateTexts();
    }

    setLanguage(lang) {
        if (TRANSLATIONS[lang]) {
            this.currentLang = lang;
            this.updateTexts();
            this.updateButtons();
        }
    }

    updateButtons() {
        document.getElementById('btn-lang-en').classList.toggle('active', this.currentLang === 'en');
        document.getElementById('btn-lang-ru').classList.toggle('active', this.currentLang === 'ru');
    }

    updateTexts() {
        const t = TRANSLATIONS[this.currentLang];
        const set = (id, txt) => { const el = document.getElementById(id); if (el) el.innerHTML = txt; };
        
        set('txt-title', t.title);
        set('txt-tap', t.tap);
        set('btn-start', t.start);
        set('btn-shop-open', t.shop);
        set('txt-shop-title', t.shop_title);
        set('txt-paused', t.paused);
        set('btn-resume', t.resume);
        set('txt-failed', t.failed);
        set('txt-score-label', t.score_label);
        set('txt-best-label', t.best_label);
        set('btn-restart', t.retry);
        set('btn-revive', t.revive_btn);
        set('txt-settings-title', t.settings_title);
        set('txt-lang-label', t.lang_label);
        set('btn-settings-back', t.back);
        set('btn-shop-back', t.back);
        set('btn-shop-free-credits', t.free_credits);
        set('btn-pause-menu', t.menu_btn);
        set('btn-gameover-menu', t.menu_btn);
    }
    
    get(key) { return TRANSLATIONS[this.currentLang][key] || key; }
}

class SoundManager {
    constructor() {
        this.ctx = null;
        this.muted = false;
        this.initialized = false;
        this.lastJump = 0;
        this.lastScore = 0;
        this.lastClick = 0;
        this.active = 0;
        this.max = 6;
    }

    init() {
        if (this.initialized) return;
        try {
            this.ctx = new (window.AudioContext || window.webkitAudioContext)({ latencyHint: 'interactive' });
            this.initialized = true;
        } catch (e) {}
    }

    toggleMute() {
        this.muted = !this.muted;
        if (!this.muted && this.ctx?.state === 'suspended') this.ctx.resume();
        return this.muted;
    }

    suspend() { if (this.ctx?.state === 'running') this.ctx.suspend(); }
    resume() { if (this.ctx?.state === 'suspended' && !this.muted) this.ctx.resume(); }

    _ok(last, th) {
        if (!this.initialized) this.init();
        if (!this.ctx || this.muted || this.active >= this.max) return false;
        if (performance.now() - last < th) return false;
        if (this.ctx.state === 'suspended') this.ctx.resume();
        return true;
    }

    _play(freq, type, dur, vol) {
        this.active++;
        const t = this.ctx.currentTime;
        const o = this.ctx.createOscillator();
        const g = this.ctx.createGain();
        o.connect(g); g.connect(this.ctx.destination);
        o.type = type;
        o.frequency.setValueAtTime(freq, t);
        g.gain.setValueAtTime(vol, t);
        g.gain.exponentialRampToValueAtTime(0.001, t + dur);
        o.onended = () => this.active--;
        o.start(t); o.stop(t + dur);
    }

    playJump() {
        if (!this._ok(this.lastJump, 50)) return;
        this.lastJump = performance.now();
        const t = this.ctx.currentTime;
        const o = this.ctx.createOscillator();
        const g = this.ctx.createGain();
        o.connect(g); g.connect(this.ctx.destination);
        o.type = 'square';
        o.frequency.setValueAtTime(150, t);
        o.frequency.exponentialRampToValueAtTime(400, t + 0.05);
        g.gain.setValueAtTime(0.07, t);
        g.gain.exponentialRampToValueAtTime(0.001, t + 0.05);
        this.active++;
        o.onended = () => this.active--;
        o.start(t); o.stop(t + 0.05);
    }

    playScore() {
        if (!this._ok(this.lastScore, 80)) return;
        this.lastScore = performance.now();
        this._play(1000, 'sine', 0.08, 0.04);
    }

    playCrash() {
        if (!this._ok(0, 0)) return;
        const t = this.ctx.currentTime;
        const o = this.ctx.createOscillator();
        const g = this.ctx.createGain();
        o.connect(g); g.connect(this.ctx.destination);
        o.type = 'sawtooth';
        o.frequency.setValueAtTime(100, t);
        o.frequency.exponentialRampToValueAtTime(10, t + 0.25);
        g.gain.setValueAtTime(0.08, t);
        g.gain.exponentialRampToValueAtTime(0.001, t + 0.25);
        this.active++;
        o.onended = () => this.active--;
        o.start(t); o.stop(t + 0.25);
    }

    playClick() {
        if (!this._ok(this.lastClick, 30)) return;
        this.lastClick = performance.now();
        this._play(1200, 'sine', 0.06, 0.04);
    }

    playBack() {
        if (!this._ok(0, 0)) return;
        this._play(400, 'sine', 0.1, 0.04);
    }

    playSuccess() {
        if (!this._ok(0, 0)) return;
        const t = this.ctx.currentTime;
        [520, 660, 780].forEach((f, i) => {
            if (this.active >= this.max) return;
            this.active++;
            const o = this.ctx.createOscillator();
            const g = this.ctx.createGain();
            o.connect(g); g.connect(this.ctx.destination);
            o.type = 'square';
            o.frequency.setValueAtTime(f, t + i * 0.05);
            g.gain.setValueAtTime(0.04, t + i * 0.05);
            g.gain.exponentialRampToValueAtTime(0.001, t + i * 0.05 + 0.08);
            o.onended = () => this.active--;
            o.start(t + i * 0.05); o.stop(t + i * 0.05 + 0.08);
        });
    }

    playError() {
        if (!this._ok(0, 0)) return;
        this._play(120, 'sawtooth', 0.15, 0.06);
    }
}

const CONFIG = {
    logicalWidth: 720,
    gravity: 1900,
    jumpForce: -620,
    terminalVelocity: 1000,
    initialSpeed: 350,
    speed: 350,
    speedStep: 1.5,
    maxSpeed: 600,
    gapSize: 220,
    minPipeDistance: 480
};

const STATE = { START: 0, PLAYING: 1, PAUSED: 2, GAMEOVER: 3, SETTINGS: 4, SHOP: 5 };

class Game {
    constructor() {
        this.canvas = document.getElementById('gameCanvas');
        this.ctx = this.canvas.getContext('2d');
        this.wrapper = document.getElementById('game-wrapper');
        this.canvas.width = CONFIG.logicalWidth;
        this.canvas.height = 1280;

        this.ui = {
            start: document.getElementById('start-screen'),
            gameover: document.getElementById('gameover-screen'),
            pause: document.getElementById('pause-screen'),
            settings: document.getElementById('settings-screen'),
            shop: document.getElementById('shop-screen'),
            hud: document.getElementById('hud'),
            score: document.getElementById('score-display'),
            finalScore: document.getElementById('final-score'),
            bestScore: document.getElementById('best-score'),
            btnStart: document.getElementById('btn-start'),
            btnShopOpen: document.getElementById('btn-shop-open'),
            btnShopBack: document.getElementById('btn-shop-back'),
            btnShopPrev: document.getElementById('btn-shop-prev'),
            btnShopNext: document.getElementById('btn-shop-next'),
            btnShopSelect: document.getElementById('btn-shop-select'),
            btnShopFreeCredits: document.getElementById('btn-shop-free-credits'),
            shopSkinName: document.getElementById('shop-skin-name'),
            shopCanvas: document.getElementById('shopCanvas'),
            shopCredits: document.getElementById('shop-credits'),
            btnRestart: document.getElementById('btn-restart'),
            btnRevive: document.getElementById('btn-revive'),
            btnResume: document.getElementById('btn-resume'),
            btnPauseMenu: document.getElementById('btn-pause-menu'),
            btnGameOverMenu: document.getElementById('btn-gameover-menu'),
            btnPause: document.getElementById('btn-toggle-pause'),
            btnSound: document.getElementById('btn-toggle-sound'),
            btnSettingsOpen: document.getElementById('btn-settings-open'),
            btnSettingsBack: document.getElementById('btn-settings-back'),
            btnLangEn: document.getElementById('btn-lang-en'),
            btnLangRu: document.getElementById('btn-lang-ru')
        };

        this.lang = new LanguageManager();
        this.lang.updateButtons();
        this.sound = new SoundManager();
        this.state = STATE.START;
        
        this.lastTime = 0;
        this.score = 0;
        this.highScore = parseInt(localStorage.getItem('cybercat_highscore')) || 0;
        this.credits = parseInt(localStorage.getItem('cybercat_credits')) || 0;
        this.inventory = JSON.parse(localStorage.getItem('cybercat_inventory')) || [0];
        this.hasRevived = false;

        this.selectedSkinId = parseInt(localStorage.getItem('cybercat_skin')) || 0;
        this.browsingSkinIndex = this.selectedSkinId;
        this.shopCtx = this.ui.shopCanvas.getContext('2d');

        this.cat = new Cat(this);
        this.obstacles = [];
        this.background = new Background(this);
        this.particles = [];
        for (let i = 0; i < 25; i++) this.particles.push(new Particle());

        this.initListeners();
        this.resize();
        requestAnimationFrame(t => this.loop(t));
    }

    initListeners() {
        window.addEventListener('resize', () => this.resize());
        
        const unlock = () => {
            this.sound.init();
            this.sound.resume();
            document.removeEventListener('pointerdown', unlock);
            document.removeEventListener('keydown', unlock);
        };
        document.addEventListener('pointerdown', unlock);
        document.addEventListener('keydown', unlock);

        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                this.sound.suspend();
                if (this.state === STATE.PLAYING) this.togglePause();
            } else {
                this.sound.resume();
            }
        });

        this.ui.btnStart.onclick = e => { e.preventDefault(); this.sound.init(); this.sound.playClick(); this.startGame(); };
        this.ui.btnRestart.onclick = e => { e.preventDefault(); this.sound.playClick(); this.showAdAndRestart(); };
        this.ui.btnRevive.onclick = e => { e.preventDefault(); this.sound.playClick(); this.showReviveAd(); };
        this.ui.btnResume.onclick = e => { e.preventDefault(); this.sound.playClick(); this.togglePause(); };
        
        this.ui.btnShopOpen.onclick = e => { e.preventDefault(); this.sound.playClick(); this.openShop(); };
        this.ui.btnShopBack.onclick = e => { e.preventDefault(); this.sound.playBack(); this.closeShop(); };
        this.ui.btnShopPrev.onclick = e => { e.preventDefault(); this.sound.playClick(); this.changeSkin(-1); };
        this.ui.btnShopNext.onclick = e => { e.preventDefault(); this.sound.playClick(); this.changeSkin(1); };
        this.ui.btnShopSelect.onclick = e => { e.preventDefault(); this.handleShopAction(); };
        this.ui.btnShopFreeCredits.onclick = e => { e.preventDefault(); this.sound.playClick(); this.watchAdForCredits(); };

        const menuHandler = e => {
            e.preventDefault();
            this.sound.playBack();
            if (window.ysdk) {
                this.sound.suspend();
                window.ysdk.adv.showFullscreenAdv({
                    callbacks: {
                        onClose: () => { this.sound.resume(); this.exitToMenu(); },
                        onError: () => { this.sound.resume(); this.exitToMenu(); }
                    }
                });
            } else this.exitToMenu();
        };
        this.ui.btnPauseMenu.onclick = menuHandler;
        this.ui.btnGameOverMenu.onclick = menuHandler;

        this.ui.btnPause.onclick = e => { e.stopPropagation(); this.sound.playClick(); this.togglePause(); };
        this.ui.btnSound.onclick = e => {
            e.stopPropagation();
            const m = this.sound.toggleMute();
            if (!m) this.sound.playClick();
            this.ui.btnSound.innerText = m ? 'üîá' : 'üîä';
            this.ui.btnSound.classList.toggle('muted', m);
        };

        this.ui.btnSettingsOpen.onclick = e => { e.stopPropagation(); this.sound.playClick(); this.openSettings(); };
        this.ui.btnSettingsBack.onclick = e => { e.stopPropagation(); this.sound.playBack(); this.closeSettings(); };
        this.ui.btnLangEn.onclick = e => { e.stopPropagation(); this.sound.playClick(); this.lang.setLanguage('en'); this.updateShopUI(); };
        this.ui.btnLangRu.onclick = e => { e.stopPropagation(); this.sound.playClick(); this.lang.setLanguage('ru'); this.updateShopUI(); };

        this.wrapper.addEventListener('pointerdown', e => {
            if (e.target.tagName === 'BUTTON') return;
            if (this.state === STATE.PLAYING) this.cat.jump();
        });

        window.addEventListener('keydown', e => {
            if ((e.code === 'Space' || e.code === 'ArrowUp') && this.state === STATE.PLAYING) this.cat.jump();
            if (e.code === 'Escape' && (this.state === STATE.PLAYING || this.state === STATE.PAUSED)) this.togglePause();
        });
    }

    spawnParticle(x, y) {
        const p = this.particles.find(p => !p.active);
        if (p) p.activate(x, y, this.selectedSkinId);
    }

    resize() {
        const w = window.innerWidth, h = window.innerHeight;
        const ew = Math.min(w, h * 0.6);
        this.canvas.width = CONFIG.logicalWidth;
        this.canvas.height = CONFIG.logicalWidth / (ew / h);
    }

    openShop() {
        this.state = STATE.SHOP;
        this.browsingSkinIndex = this.selectedSkinId;
        this.ui.start.classList.add('hidden');
        this.ui.shop.classList.remove('hidden');
        this.ui.btnSettingsOpen.style.display = 'none';
        this.updateShopUI();
    }

    closeShop() {
        this.state = STATE.START;
        this.ui.shop.classList.add('hidden');
        this.ui.start.classList.remove('hidden');
        this.ui.btnSettingsOpen.style.display = 'flex';
    }

    changeSkin(d) {
        this.browsingSkinIndex = (this.browsingSkinIndex + d + SKINS.length) % SKINS.length;
        this.updateShopUI();
    }

    handleShopAction() {
        const skin = SKINS[this.browsingSkinIndex];
        const owned = this.inventory.includes(skin.id);

        if (owned) {
            this.selectedSkinId = this.browsingSkinIndex;
            localStorage.setItem('cybercat_skin', this.selectedSkinId);
            this.cat.updateSkin();
            this.sound.playSuccess();
        } else if (this.credits >= skin.price) {
            this.credits -= skin.price;
            this.inventory.push(skin.id);
            this.selectedSkinId = skin.id;
            localStorage.setItem('cybercat_credits', this.credits);
            localStorage.setItem('cybercat_inventory', JSON.stringify(this.inventory));
            localStorage.setItem('cybercat_skin', this.selectedSkinId);
            this.cat.updateSkin();
            this.sound.playSuccess();
        } else {
            this.sound.playError();
        }
        this.updateShopUI();
    }
    
    watchAdForCredits() {
        let rewarded = false;
        const finish = () => {
            this.sound.resume();
            if (rewarded) {
                this.credits += 100;
                localStorage.setItem('cybercat_credits', this.credits);
                this.sound.playSuccess();
                this.updateShopUI();
            }
        };

        if (window.ysdk) {
            this.sound.suspend();
            window.ysdk.adv.showRewardedVideo({
                callbacks: { onRewarded: () => { rewarded = true; }, onClose: finish, onError: finish }
            });
        } else { rewarded = true; finish(); }
    }

    updateShopUI() {
        const skin = SKINS[this.browsingSkinIndex];
        this.ui.shopSkinName.innerText = this.lang.get(skin.nameKey);
        this.ui.shopCredits.innerText = `${this.lang.get('credits')}: ${this.credits}`;
        this.ui.btnShopFreeCredits.innerHTML = this.lang.get('free_credits');
        
        document.getElementById('txt-shop-title').innerText = this.lang.get('shop_title');

        const owned = this.inventory.includes(skin.id);
        const selected = this.selectedSkinId === skin.id;
        const btn = this.ui.btnShopSelect;

        btn.classList.remove('btn-disabled', 'btn-warning', 'btn-success', 'btn-danger');

        if (owned) {
            if (selected) {
                btn.innerText = this.lang.get('selected');
                btn.classList.add('btn-disabled');
            } else {
                btn.innerText = this.lang.get('select');
                btn.classList.add('btn-success');
            }
        } else {
            btn.innerText = `${this.lang.get('buy')} (${skin.price})`;
            btn.classList.add(this.credits >= skin.price ? 'btn-warning' : 'btn-danger');
        }
        
        this.drawShopPreview();
    }

    drawShopPreview() {
        const ctx = this.shopCtx;
        const cw = this.ui.shopCanvas.width, ch = this.ui.shopCanvas.height;
        ctx.clearRect(0, 0, cw, ch);
        ctx.fillStyle = "#0a0a0a";
        ctx.fillRect(0, 0, cw, ch);
        ctx.save();
        ctx.translate(cw / 2, ch / 2);
        drawCatVisuals(ctx, 45, 36, this.browsingSkinIndex, null);
        ctx.restore();
    }

    openSettings() {
        this.prevState = this.state === STATE.PAUSED ? STATE.PAUSED : STATE.START;
        this.state = STATE.SETTINGS;
        this.ui.start.classList.add('hidden');
        this.ui.pause.classList.add('hidden');
        this.ui.settings.classList.remove('hidden');
        this.ui.btnSettingsOpen.style.display = 'none';
        this.ui.btnPause.style.display = 'none';
    }

    closeSettings() {
        this.state = this.prevState;
        this.ui.settings.classList.add('hidden');
        if (this.state === STATE.START) {
            this.ui.start.classList.remove('hidden');
            this.ui.btnSettingsOpen.style.display = 'flex';
        } else if (this.state === STATE.PAUSED) {
            this.ui.pause.classList.remove('hidden');
        }
    }

    exitToMenu() {
        this.state = STATE.START;
        ['settings', 'pause', 'gameover', 'hud'].forEach(k => this.ui[k].classList.add('hidden'));
        this.ui.start.classList.remove('hidden');
        this.ui.btnSettingsOpen.style.display = 'flex';
        this.ui.btnPause.style.display = 'none';
        this.cat.reset();
        this.obstacles = [];
        this.particles.forEach(p => p.active = false);
        this.score = 0;
        CONFIG.speed = CONFIG.initialSpeed;
        this.hasRevived = false;
        this.lastTime = performance.now();
    }

    startGame() {
        this.state = STATE.PLAYING;
        this.ui.start.classList.add('hidden');
        this.ui.hud.classList.remove('hidden');
        this.ui.btnPause.style.display = 'flex';
        this.ui.btnSettingsOpen.style.display = 'none';
        CONFIG.speed = CONFIG.initialSpeed;
        this.hasRevived = false;
        this.cat.updateSkin();
        this.cat.reset();
        this.cat.jump();
        this.score = 0;
        this.ui.score.innerText = '0';
        this.lastTime = performance.now();
    }

    showAdAndRestart() {
        const finish = () => { this.sound.resume(); this.resetGame(); };
        if (window.ysdk) {
            this.sound.suspend();
            window.ysdk.adv.showFullscreenAdv({ callbacks: { onClose: finish, onError: finish } });
        } else finish();
    }

    showReviveAd() {
        let rewarded = false;
        const finish = () => { this.sound.resume(); if (rewarded) this.reviveHero(); };
        if (window.ysdk) {
            this.sound.suspend();
            window.ysdk.adv.showRewardedVideo({ callbacks: { onRewarded: () => { rewarded = true; }, onClose: finish, onError: finish } });
        } else { rewarded = true; finish(); }
    }

    reviveHero() {
        this.hasRevived = true;
        this.state = STATE.PLAYING;
        this.ui.gameover.classList.add('hidden');
        this.ui.hud.classList.remove('hidden');
        this.ui.btnPause.style.display = 'flex';
        this.cat.y = this.canvas.height / 2;
        this.cat.velocity = 0;
        this.cat.rotation = 0;
        this.obstacles = [];
        this.lastTime = performance.now();
        this.cat.jump();
    }

    resetGame() {
        this.cat = new Cat(this);
        this.obstacles = [];
        this.particles.forEach(p => p.active = false);
        this.score = 0;
        this.hasRevived = false;
        CONFIG.speed = CONFIG.initialSpeed;
        this.state = STATE.PLAYING;
        this.ui.gameover.classList.add('hidden');
        this.ui.hud.classList.remove('hidden');
        this.ui.btnPause.style.display = 'flex';
        this.cat.jump();
        this.ui.score.innerText = '0';
        this.lastTime = performance.now();
    }

    togglePause() {
        if (this.state === STATE.PLAYING) {
            this.state = STATE.PAUSED;
            this.ui.pause.classList.remove('hidden');
            this.ui.btnPause.style.display = 'none';
        } else if (this.state === STATE.PAUSED) {
            this.state = STATE.PLAYING;
            this.ui.pause.classList.add('hidden');
            this.ui.btnPause.style.display = 'flex';
            this.lastTime = performance.now();
        }
    }

    gameOver() {
        this.ui.gameover.classList.remove('hidden');
        this.state = STATE.GAMEOVER;
        this.sound.playCrash();
        this.credits += this.score;
        localStorage.setItem('cybercat_credits', this.credits);
        if (this.score > this.highScore) {
            this.highScore = this.score;
            localStorage.setItem('cybercat_highscore', this.highScore);
        }
        this.ui.hud.classList.add('hidden');
        this.ui.btnPause.style.display = 'none';
        this.ui.finalScore.innerText = this.score;
        this.ui.bestScore.innerText = this.highScore;
        this.ui.btnRevive.style.display = this.hasRevived ? 'none' : 'block';
    }

    loop(ts) {
        if (!this.lastTime) this.lastTime = ts;
        let dt = (ts - this.lastTime) / 1000;
        this.lastTime = ts;
        if (dt > 0.1) dt = 0.1;

        this.update(dt);
        this.draw();
        requestAnimationFrame(t => this.loop(t));
    }

    update(dt) {
        if (this.state === STATE.SHOP || this.state === STATE.PAUSED || this.state === STATE.SETTINGS) return;

        this.background.update(dt);
        for (let p of this.particles) if (p.active) p.update(dt);

        if (this.state === STATE.PLAYING) {
            this.cat.update(dt);
            
            const sr = (CONFIG.speed - CONFIG.initialSpeed) / (CONFIG.maxSpeed - CONFIG.initialSpeed);
            const minDist = CONFIG.minPipeDistance - sr * 50;

            if (!this.obstacles.length) {
                this.obstacles.push(new Obstacle(this));
            } else {
                const last = this.obstacles[this.obstacles.length - 1];
                if (CONFIG.logicalWidth - last.x >= minDist) this.obstacles.push(new Obstacle(this, last));
            }

            const px = this.cat.w * 0.2, py = this.cat.h * 0.2;
            const cl = this.cat.x + px, cr = this.cat.x + this.cat.w - px;
            const ct = this.cat.y + py, cb = this.cat.y + this.cat.h - py;

            for (let i = this.obstacles.length - 1; i >= 0; i--) {
                const o = this.obstacles[i];
                o.update(dt);
                
                if (!o.passed && this.cat.x > o.x + o.w) {
                    o.passed = true;
                    this.score++;
                    this.ui.score.innerText = this.score;
                    this.sound.playScore();
                    CONFIG.speed = Math.min(CONFIG.maxSpeed, CONFIG.speed + CONFIG.speedStep);
                }

                if (o.x + o.w < 0) { this.obstacles.splice(i, 1); continue; }

                if (cr > o.x && cl < o.x + o.w && (ct < o.topH || cb > o.bottomY)) this.gameOver();
            }

            if (this.cat.y + this.cat.h >= this.canvas.height || this.cat.y <= 0) this.gameOver();
        } else if (this.state === STATE.GAMEOVER) {
            if (this.cat.y + this.cat.h < this.canvas.height) {
                this.cat.velocity += CONFIG.gravity * dt;
                this.cat.y += this.cat.velocity * dt;
            }
        }
    }

    draw() {
        if (this.state === STATE.SHOP) return;
        const c = this.ctx;
        c.fillStyle = "#0d001a";
        c.fillRect(0, 0, this.canvas.width, this.canvas.height);
        this.background.draw(c);
        for (let o of this.obstacles) o.draw(c);
        for (let p of this.particles) if (p.active) p.draw(c);
        this.cat.draw(c);
        if (this.state === STATE.PAUSED || this.state === STATE.SETTINGS) {
            c.fillStyle = "rgba(0,0,0,0.4)";
            c.fillRect(0, 0, this.canvas.width, this.canvas.height);
        }
    }
}

function drawCatVisuals(ctx, w, h, skinId, vel) {
    const skin = SKINS[skinId];
    let fill = skin.bodyColor || "#000";
    let stroke = skin.color;
    
    if (skinId === 4) {
        const g = ctx.createLinearGradient(-w/2, -h/2, w/2, h/2);
        g.addColorStop(0, "#FFD700");
        g.addColorStop(1, "#FFA500");
        fill = g;
        stroke = "#FFA500";
    }

    if (vel === null || vel < 0) {
        const len = 18 + Math.random() * 12;
        ctx.fillStyle = skin.flame;
        ctx.shadowBlur = 12;
        ctx.shadowColor = skin.flame;
        ctx.beginPath();
        ctx.moveTo(-w/2 - 8, -4);
        ctx.lineTo(-w/2 - 8 - len, 4);
        ctx.lineTo(-w/2 - 8, 12);
        ctx.fill();
        ctx.shadowBlur = 0;
    }

    ctx.fillStyle = skin.jetpackColor || '#555';
    ctx.fillRect(-w/2 - 8, -4, 8, 16);

    ctx.shadowBlur = skinId === 4 ? 18 : 10;
    ctx.shadowColor = skin.color;
    ctx.strokeStyle = stroke;
    ctx.lineWidth = 2.5;
    ctx.fillStyle = fill;
    ctx.fillRect(-w/2, -h/2, w, h);
    ctx.strokeRect(-w/2, -h/2, w, h);

    if (skinId !== 4) {
        ctx.lineWidth = 2;
        ctx.strokeStyle = stroke;
        ctx.beginPath();
        ctx.moveTo(-8, -h/2); ctx.lineTo(-16, -h/2 - 12); ctx.lineTo(0, -h/2);
        ctx.moveTo(4, -h/2); ctx.lineTo(12, -h/2 - 12); ctx.lineTo(20, -h/2);
        ctx.stroke();
    }

    ctx.shadowBlur = 0;
    ctx.fillStyle = skin.eyeColor;
    ctx.fillRect(6, -10, 7, 7);

    if (skinId === 3) {
        ctx.strokeStyle = "#000";
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(4, -14);
        ctx.lineTo(15, -8);
        ctx.stroke();
    } else if (skinId === 4) {
        ctx.strokeStyle = "#FFD700";
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(-8, -h/2);
        ctx.lineTo(-12, -h/2 - 12);
        ctx.lineTo(-4, -h/2 - 4);
        ctx.lineTo(0, -h/2 - 16);
        ctx.lineTo(4, -h/2 - 4);
        ctx.lineTo(12, -h/2 - 12);
        ctx.lineTo(8, -h/2);
        ctx.stroke();
    }
}

class Cat {
    constructor(game) {
        this.game = game;
        this.w = 50;
        this.h = 40;
        this.skin = SKINS[game.selectedSkinId];
        this.reset();
    }

    updateSkin() { this.skin = SKINS[this.game.selectedSkinId]; }

    reset() {
        this.x = this.game.canvas.width / 2 - 100;
        this.y = this.game.canvas.height / 2;
        this.velocity = 0;
        this.rotation = 0;
        this.timer = 0;
    }

    jump() {
        this.velocity = CONFIG.jumpForce;
        this.rotation = -20;
        this.game.sound.playJump();
        for (let i = 0; i < 3; i++) this.game.spawnParticle(this.x, this.y + this.h / 2);
    }

    update(dt) {
        this.velocity += CONFIG.gravity * dt;
        if (this.velocity > CONFIG.terminalVelocity) this.velocity = CONFIG.terminalVelocity;
        this.y += this.velocity * dt;
        this.rotation = this.velocity < 0 ? Math.max(-20, this.rotation - 600 * dt) : Math.min(45, this.rotation + 200 * dt);
        this.timer += dt;
        if (this.timer > 0.08) {
            this.game.spawnParticle(this.x, this.y + this.h / 2 + 5);
            this.timer = 0;
        }
    }

    draw(ctx) {
        ctx.save();
        ctx.translate(~~(this.x + this.w / 2), ~~(this.y + this.h / 2));
        ctx.rotate(this.rotation * Math.PI / 180);
        drawCatVisuals(ctx, this.w, this.h, this.skin.id, this.velocity);
        ctx.restore();
    }
}

class Obstacle {
    constructor(game, last = null) {
        this.game = game;
        this.w = 70;
        this.x = game.canvas.width;
        this.passed = false;
        const minH = 150;
        const maxT = game.canvas.height - CONFIG.gapSize - minH;
        let minS = minH, maxS = maxT;
        if (last) {
            const d = 400;
            minS = Math.max(minH, last.topH - d);
            maxS = Math.min(maxT, last.topH + d);
        }
        this.topH = Math.floor(Math.random() * (maxS - minS + 1) + minS);
        this.bottomY = this.topH + CONFIG.gapSize;
    }
    
    update(dt) { this.x -= CONFIG.speed * dt; }
    
    draw(ctx) {
        const x = ~~this.x, w = this.w, th = ~~this.topH, by = ~~this.bottomY;
        const gh = this.game.canvas.height - this.bottomY;

        ctx.lineWidth = 12;
        ctx.strokeStyle = "rgba(0,255,0,0.2)";
        ctx.strokeRect(x, -5, w, th + 5);
        ctx.strokeRect(x, by, w, gh + 5);

        ctx.fillStyle = "#001a00";
        ctx.strokeStyle = "#0f0";
        ctx.lineWidth = 3;
        ctx.fillRect(x, 0, w, th);
        ctx.strokeRect(x, -5, w, th + 5);
        ctx.fillStyle = "#0f0";
        ctx.fillRect(x + 10, th - 35, w - 20, 8);
        
        ctx.fillStyle = "#001a00";
        ctx.fillRect(x, by, w, gh);
        ctx.strokeRect(x, by, w, gh + 5);
        ctx.fillStyle = "#0f0";
        ctx.fillRect(x + 10, by + 27, w - 20, 8);
    }
}

class Particle {
    constructor() { this.active = false; }

    activate(x, y, skinId) {
        this.x = x;
        this.y = y;
        this.life = 1;
        this.size = 3 + Math.random() * 4;
        this.vx = -150 - Math.random() * 100;
        this.vy = (Math.random() - 0.5) * 150;
        this.color = SKINS[skinId].flame;
        this.active = true;
    }
    
    update(dt) {
        this.x += this.vx * dt;
        this.y += this.vy * dt;
        this.life -= 3 * dt;
        this.size *= 1 - 2.5 * dt;
        if (this.life <= 0 || this.size < 0.5) this.active = false;
    }
    
    draw(ctx) {
        ctx.globalAlpha = Math.max(0, this.life);
        ctx.fillStyle = this.color;
        ctx.fillRect(~~this.x, ~~this.y, ~~this.size, ~~this.size);
        ctx.globalAlpha = 1;
    }
}

class Background {
    constructor(game) {
        this.game = game;
        this.x = 0;
        this.buildings = [];
        for (let i = 0; i < 12; i++) {
            this.buildings.push({
                x: i * 120,
                w: 50 + Math.random() * 40,
                h: 180 + Math.random() * 400,
                c: `rgba(20,0,50,${0.3 + Math.random() * 0.35})`
            });
        }
    }
    
    update(dt) {
        if (this.game.state === STATE.PLAYING) {
            this.x -= CONFIG.speed * 0.06 * dt;
            if (this.x <= -CONFIG.logicalWidth) this.x = 0;
        }
    }
    
    draw(ctx) {
        ctx.strokeStyle = "rgba(80,0,200,0.06)";
        ctx.lineWidth = 1;
        const gs = 120, off = ~~this.x % gs;
        for (let x = off; x < CONFIG.logicalWidth; x += gs) {
            ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, this.game.canvas.height); ctx.stroke();
        }
        for (let y = 0; y < this.game.canvas.height; y += gs) {
            ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(CONFIG.logicalWidth, y); ctx.stroke();
        }
        ctx.save();
        ctx.translate(~~this.x, 0);
        for (let j = 0; j < 2; j++) {
            const s = j * 1440;
            for (let b of this.buildings) {
                ctx.fillStyle = b.c;
                ctx.fillRect(~~(b.x + s), ~~(this.game.canvas.height - b.h), ~~b.w, ~~b.h);
            }
        }
        ctx.restore();
    }
}

let game = null;

function initYandex() {
    YaGames.init().then(y => {
        ysdk = y;
        if (ysdk.deviceInfo.type === 'mobile' || ysdk.deviceInfo.type === 'tablet') {
            document.body.classList.add('mobile-device');
        }
        ysdk.features.LoadingAPI.ready();
        if (game?.lang) { game.lang.init(); game.lang.updateButtons(); }
    }).catch(console.error);
}

window.onload = () => {
    game = new Game();
    initYandex();
};
</script>
</body>
</html>
