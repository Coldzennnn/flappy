<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <!-- Yandex Games SDK -->
    <script src="https://yandex.ru/games/sdk/v2"></script>
    <title>–ö–∏–±–µ—Ä –ö–æ—Ç: –ü–æ–ª—ë—Ç</title>
    <style>
        /* --- –ë–ê–ó–û–í–´–ï –ù–ê–°–¢–†–û–ô–ö–ò --- */
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            margin: 0;
            padding: 0;
            width: 100vw;
            height: 100dvh; 
            background: #0d001a; 
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            font-family: 'Courier New', Courier, monospace;
            
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            -webkit-touch-callout: none;
            touch-action: none;
        }

        /* --- –ò–ì–†–û–í–û–ô –ö–û–ù–¢–ï–ô–ù–ï–† --- */
        #game-wrapper {
            position: relative;
            width: 100%; 
            height: 100%;
            max-width: 60vh; 
            box-shadow: 0 0 100px rgba(0, 255, 255, 0.2);
            overflow: hidden;
            background-color: #000;
        }

        canvas {
            display: block;
            width: 100%;
            height: 100%;
            object-fit: contain; 
            background: linear-gradient(180deg, #0d001a 0%, #000033 100%);
        }

        /* --- UI –°–õ–û–ô --- */
        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            z-index: 10;
        }

        /* --- –í–ï–†–•–ù–Ø–Ø –ü–ê–ù–ï–õ–¨ --- */
        #top-bar {
            position: absolute;
            top: 15px;
            right: 15px;
            display: flex;
            gap: 10px;
            pointer-events: auto;
            z-index: 100;
        }

        .icon-btn {
            width: 48px;
            height: 48px;
            min-width: 48px;
            min-height: 48px;
            background: rgba(0, 20, 40, 0.8);
            border: 2px solid #0ff;
            color: #0ff;
            font-size: 22px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.3);
            border-radius: 8px;
            transition: all 0.15s;
        }

        .icon-btn:active {
            background: #0ff;
            color: #000;
            transform: scale(0.92);
        }

        .icon-btn.muted {
            border-color: #ff0055;
            color: #ff0055;
            box-shadow: 0 0 10px rgba(255, 0, 85, 0.3);
        }

        #btn-settings-open {
            position: absolute;
            top: 15px;
            left: 15px;
            pointer-events: auto;
            z-index: 100;
        }

        /* --- –≠–ö–†–ê–ù–´ --- */
        .screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            pointer-events: auto;
            transition: opacity 0.3s;
            z-index: 15;
            padding: 15px;
            overflow-y: auto;
        }

        .screen.hidden {
            opacity: 0;
            pointer-events: none;
        }

        /* --- –ö–ê–†–¢–û–ß–ù–ê–Ø –°–ò–°–¢–ï–ú–ê --- */
        .card {
            background: rgba(0, 0, 0, 0.85);
            border: 1px solid #0ff;
            border-radius: 15px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.15);
            width: 90%;
            max-width: 320px;
            text-align: center;
        }

        .card-red {
            border-color: #ff0055;
            box-shadow: 0 0 20px rgba(255, 0, 85, 0.15);
        }

        /* --- –¢–ò–ü–û–ì–†–ê–§–ò–ö–ê --- */
        .game-title {
            color: #0ff;
            font-size: clamp(28px, 6vh, 48px);
            margin: 0 0 20px 0;
            text-shadow: 0 0 10px #0ff, 0 0 20px #0ff;
            text-align: center;
            line-height: 1.1;
        }

        .mission-failed {
            color: #ff0055;
            font-size: clamp(24px, 5vh, 40px);
            margin: 0 0 15px 0;
            text-shadow: 0 0 10px #ff0055;
            text-align: center;
            font-weight: bold;
            line-height: 1.1;
        }

        .label {
            color: #aaa;
            font-size: clamp(10px, 1.8vh, 14px);
            letter-spacing: 2px;
            margin-bottom: 5px;
            text-transform: uppercase;
        }

        .score-big {
            font-size: clamp(40px, 8vh, 64px);
            color: #fff;
            font-weight: bold;
            margin: 0 0 10px 0;
            text-shadow: 0 0 10px rgba(255,255,255,0.5);
            line-height: 1;
        }

        .best-score-container {
            background: rgba(255, 255, 255, 0.1);
            padding: 8px 15px;
            border-radius: 20px;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .best-label {
            color: #0ff;
            font-size: clamp(12px, 2vh, 16px);
            font-weight: bold;
        }

        .best-value {
            color: #fff;
            font-size: clamp(12px, 2vh, 16px);
        }

        .title-paused {
            color: #FFFF00;
            text-shadow: 0 0 10px #FFFF00;
            font-size: clamp(28px, 6vh, 48px);
            margin-bottom: 20px;
            text-align: center;
        }

        /* --- –ö–ù–û–ü–ö–ò --- */
        .btn {
            background: rgba(0, 20, 40, 0.9);
            border: 2px solid #0ff;
            color: #0ff;
            padding: 15px 25px;
            font-family: 'Courier New', Courier, monospace;
            font-size: clamp(14px, 2.5vh, 20px);
            font-weight: bold;
            text-transform: uppercase;
            cursor: pointer;
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.3);
            border-radius: 5px;
            transition: all 0.15s;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 50px;
            min-width: 180px;
        }

        .btn:active {
            background: #0ff;
            color: #000;
            box-shadow: 0 0 30px #0ff;
            transform: scale(0.96);
        }

        .gameover-buttons {
            display: flex;
            flex-direction: column;
            width: 100%;
            gap: 12px;
            align-items: center;
            margin-top: 10px;
        }

        .btn-wide {
            width: 85%;
            max-width: 280px;
            min-height: 52px;
            padding: 12px 15px;
            font-size: clamp(12px, 2.2vh, 18px);
        }

        .ad-hint {
            font-size: 0.7em;
            opacity: 0.6;
            margin-left: 8px;
            font-weight: normal;
        }

        .btn-restart {
            border-color: #ff0055;
            color: #ff0055;
            box-shadow: 0 0 15px rgba(255, 0, 85, 0.3);
        }
        .btn-restart:active {
            background: #ff0055;
            color: #000;
            box-shadow: 0 0 30px #ff0055;
        }
        
        .btn-revive {
            border-color: #00ff00;
            color: #00ff00;
            box-shadow: 0 0 15px rgba(0, 255, 0, 0.3);
        }
        .btn-revive:active {
            background: #00ff00;
            color: #000;
            box-shadow: 0 0 30px #00ff00;
        }

        .btn-resume {
            border-color: #FFFF00;
            color: #FFFF00;
            box-shadow: 0 0 15px rgba(255, 255, 0, 0.3);
        }
        .btn-resume:active {
            background: #FFFF00;
            color: #000;
        }

        .btn-shop {
            border-color: #f0f;
            color: #f0f;
            box-shadow: 0 0 15px rgba(255, 0, 255, 0.3);
            margin-top: 10px;
        }
        .btn-shop:active {
            background: #f0f;
            color: #000;
        }

        .btn-menu-secondary {
            border: 1px solid #aaa;
            color: #aaa;
            background: rgba(0,0,0,0.5);
            box-shadow: none;
        }
        .btn-menu-secondary:active {
            background: #aaa;
            color: #000;
        }

        /* --- SHOP STYLES (–ü–û–õ–ù–û–°–¢–¨–Æ –ü–ï–†–ï–†–ê–ë–û–¢–ê–ù) --- */
        #shop-screen {
            padding: 70px 10px 20px 10px;
            justify-content: flex-start;
            gap: 10px;
        }

        .shop-header {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 5px;
        }

        .shop-title {
            color: #0ff;
            font-size: clamp(24px, 5vh, 36px);
            margin: 0;
            text-shadow: 0 0 10px #0ff, 0 0 20px #0ff;
            text-align: center;
        }

        .shop-credits {
            color: #FFFF00;
            font-size: clamp(16px, 3vh, 24px);
            font-weight: bold;
            text-shadow: 0 0 10px #FFFF00;
            margin-top: 8px;
        }

        .shop-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            width: 100%;
            max-width: 350px;
            margin: 10px 0;
        }

        .preview-box {
            width: clamp(140px, 40vw, 180px);
            height: clamp(160px, 45vw, 220px);
            border: 2px solid #555;
            background: rgba(0,0,0,0.8);
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 15px;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            flex-shrink: 0;
        }

        #shopCanvas {
            width: clamp(100px, 30vw, 140px);
            height: clamp(100px, 30vw, 140px);
        }

        .arrow-btn {
            background: rgba(0, 20, 40, 0.8);
            border: 2px solid #0ff;
            color: #0ff;
            font-size: clamp(24px, 5vw, 36px);
            cursor: pointer;
            width: 48px;
            height: 48px;
            min-width: 48px;
            min-height: 48px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: 0.15s;
            flex-shrink: 0;
        }

        .arrow-btn:active {
            transform: scale(0.9);
            background: #0ff;
            color: #000;
        }

        .skin-name {
            color: #fff;
            font-size: clamp(12px, 2.5vw, 16px);
            margin-top: 10px;
            text-align: center;
            font-weight: bold;
            text-shadow: 0 0 5px rgba(255,255,255,0.5);
        }

        .shop-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
            width: 100%;
            max-width: 280px;
            align-items: center;
        }

        .shop-buttons .btn {
            width: 100%;
            min-height: 48px;
            font-size: clamp(12px, 2.2vh, 16px);
        }
        
        .btn-equipped {
            border-color: #555 !important;
            color: #888 !important;
            box-shadow: none !important;
            background: rgba(50,50,50,0.5) !important;
            cursor: default;
        }
        .btn-buy {
            border-color: #FFFF00 !important;
            color: #FFFF00 !important;
            box-shadow: 0 0 15px rgba(255, 255, 0, 0.3) !important;
        }
        .btn-buy:active {
            background: #FFFF00 !important;
            color: #000 !important;
        }
        .btn-locked {
            border-color: #ff0055 !important;
            color: #ff0055 !important;
            box-shadow: none !important;
            background: rgba(20,0,0,0.5) !important;
            opacity: 0.7;
        }

        /* --- –ù–ê–°–¢–†–û–ô–ö–ò (–Ø–ó–´–ö) --- */
        .lang-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            width: 100%;
            justify-content: center;
        }

        .btn-lang {
            flex: 1;
            padding: 12px 8px;
            border: 1px solid #555;
            background: rgba(0, 0, 0, 0.5);
            color: #888;
            cursor: pointer;
            font-family: inherit;
            font-size: clamp(12px, 2vh, 16px);
            transition: all 0.2s;
            min-height: 44px;
            border-radius: 5px;
        }

        .btn-lang.active {
            border-color: #0ff;
            background: rgba(0, 255, 255, 0.2);
            color: #0ff;
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.2);
        }

        /* --- HUD --- */
        #hud {
            position: absolute;
            top: 10%;
            width: 100%;
            text-align: center;
            pointer-events: none;
        }
        #score-display {
            font-size: clamp(40px, 8vh, 64px);
            color: rgba(255, 255, 255, 0.8);
            font-weight: bold;
            text-shadow: 0 0 10px #000;
        }

        /* --- ORIENTATION WARNING --- */
        #orientation-warning {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            z-index: 9999;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: #0ff;
            font-size: 20px;
            text-align: center;
            padding: 20px;
        }
        
        #orientation-warning svg {
            width: 64px;
            height: 64px;
            margin-bottom: 20px;
            animation: rotate-phone 2s infinite ease-in-out;
        }
        
        @keyframes rotate-phone {
            0% { transform: rotate(0deg); }
            50% { transform: rotate(-90deg); }
            100% { transform: rotate(0deg); }
        }

        @media (orientation: landscape) {
            body.mobile-device #orientation-warning {
                display: flex;
            }
        }

        /* --- MOBILE SPECIFIC ADJUSTMENTS --- */
        @media (max-height: 600px) {
            #shop-screen {
                padding-top: 60px;
                gap: 8px;
            }
            
            .shop-title {
                font-size: 20px;
            }
            
            .shop-credits {
                font-size: 14px;
                margin-top: 5px;
            }
            
            .preview-box {
                width: 120px;
                height: 140px;
                padding: 10px;
            }
            
            #shopCanvas {
                width: 90px;
                height: 90px;
            }
            
            .skin-name {
                font-size: 11px;
                margin-top: 5px;
            }
            
            .shop-buttons .btn {
                min-height: 44px;
                padding: 10px;
                font-size: 11px;
            }
            
            .arrow-btn {
                width: 44px;
                height: 44px;
                min-width: 44px;
                min-height: 44px;
                font-size: 20px;
            }
        }

        @media (max-height: 500px) {
            .preview-box {
                width: 100px;
                height: 120px;
            }
            
            #shopCanvas {
                width: 70px;
                height: 70px;
            }
        }
    </style>
</head>
<body>

<!-- ORIENTATION WARNING -->
<div id="orientation-warning">
    <svg viewBox="0 0 24 24" fill="currentColor">
        <path d="M17 1.01L7 1c-1.1 0-2 .9-2 2v18c0 1.1.9 2 2 2h10c1.1 0 2-.9 2-2V3c0-1.1-.9-1.99-2-1.99zM17 19H7V5h10v14z"/>
    </svg>
    <div>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–µ—Ä–µ–≤–µ—Ä–Ω–∏—Ç–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ<br>Please rotate your device</div>
</div>

<div id="game-wrapper">
    <canvas id="gameCanvas"></canvas>

    <div id="ui-layer">
        
        <!-- –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
        <div id="top-bar">
            <button id="btn-toggle-sound" class="icon-btn">üîä</button>
            <button id="btn-toggle-pause" class="icon-btn" style="display: none;">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
            </button>
        </div>

        <!-- –ö–Ω–æ–ø–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –Ω–∞ —Å—Ç–∞—Ä—Ç–æ–≤–æ–º —ç–∫—Ä–∞–Ω–µ -->
        <button id="btn-settings-open" class="icon-btn">‚öôÔ∏è</button>

        <!-- HUD -->
        <div id="hud" class="hidden">
            <div id="score-display">0</div>
        </div>

        <!-- START SCREEN -->
        <div id="start-screen" class="screen">
            <h1 class="game-title" id="txt-title">CYBER<br>CAT</h1>
            <button class="btn" id="btn-start">START MISSION</button>
            <button class="btn btn-shop" id="btn-shop-open">SHOP</button>
            <div style="color: #aaa; font-size: clamp(10px, 1.5vh, 14px); margin-top: 10px;" id="txt-tap">TAP TO JUMP</div>
        </div>
        
        <!-- SHOP SCREEN (–ü–û–õ–ù–û–°–¢–¨–Æ –ü–ï–†–ï–†–ê–ë–û–¢–ê–ù) -->
        <div id="shop-screen" class="screen hidden">
            <div class="shop-header">
                <h1 class="shop-title" id="txt-shop-title">ARMORY</h1>
                <div class="shop-credits" id="shop-credits">CREDITS: 0</div>
            </div>
            
            <div class="shop-container">
                <button class="arrow-btn" id="btn-shop-prev">‚óÄ</button>
                <div class="preview-box">
                    <canvas id="shopCanvas" width="140" height="140"></canvas>
                    <div class="skin-name" id="shop-skin-name">CYBER CAT</div>
                </div>
                <button class="arrow-btn" id="btn-shop-next">‚ñ∂</button>
            </div>

            <div class="shop-buttons">
                <button class="btn" id="btn-shop-select">SELECT</button>
                <button class="btn btn-revive" id="btn-shop-free-credits">üì∫ FREE CREDITS</button>
                <button class="btn btn-menu-secondary" id="btn-shop-back">BACK</button>
            </div>
        </div>

        <!-- PAUSE SCREEN -->
        <div id="pause-screen" class="screen hidden">
            <h2 class="title-paused" id="txt-paused">SYSTEM<br>PAUSED</h2>
            <button class="btn btn-resume" id="btn-resume">RESUME</button>
            <button class="btn btn-menu-secondary" id="btn-pause-menu" style="margin-top: 15px;">MENU</button>
        </div>

        <!-- GAMEOVER SCREEN -->
        <div id="gameover-screen" class="screen hidden">
            <div class="card card-red">
                <div class="mission-failed" id="txt-failed">MISSION<br>FAILED</div>
                <div class="label" id="txt-score-label">SCORE</div>
                <div class="score-big" id="final-score">0</div>
                <div class="best-score-container">
                    <span class="best-label" id="txt-best-label">BEST:</span>
                    <span class="best-value" id="best-score">0</span>
                </div>
            </div>

            <div class="gameover-buttons">
                <button class="btn btn-wide btn-revive" id="btn-revive" style="display: none;">
                    üì∫ REVIVE <span class="ad-hint">(Ad)</span>
                </button>
                <button class="btn btn-wide btn-restart" id="btn-restart">RETRY</button>
                <button class="btn btn-wide btn-menu-secondary" id="btn-gameover-menu">MENU</button>
            </div>
        </div>

        <!-- SETTINGS SCREEN -->
        <div id="settings-screen" class="screen hidden">
            <div class="card">
                <div class="label" style="color:#fff; font-size: clamp(18px, 3vh, 24px); margin-bottom:20px;" id="txt-settings-title">SETTINGS</div>
                
                <div class="label" id="txt-lang-label">LANGUAGE</div>
                <div class="lang-group">
                    <button class="btn-lang" id="btn-lang-en">ENGLISH</button>
                    <button class="btn-lang" id="btn-lang-ru">–†–£–°–°–ö–ò–ô</button>
                </div>
            </div>
            
            <button class="btn" id="btn-settings-back" style="margin-top: 20px;">BACK</button>
        </div>

    </div>
</div>

<script>
/**
 * YANDEX SDK GLOBAL
 */
var ysdk = null;

/**
 * SKINS CONFIG
 */
const SKINS = [
    { id: 0, nameKey: 'skin_0', price: 0, color: '#00FFFF', flame: '#FFFF00', eyeColor: '#fff', jetpackColor: '#FFFF00', bodyColor: '#000' },
    { id: 1, nameKey: 'skin_1', price: 100, color: '#FF00FF', flame: '#ff66ff', eyeColor: '#0ff', jetpackColor: '#800080', bodyColor: '#1a001a' },
    { id: 2, nameKey: 'skin_2', price: 250, color: '#00FFFF', flame: '#e0ffff', eyeColor: '#0088ff', jetpackColor: '#C0C0C0', bodyColor: '#FFFFFF' },
    { id: 3, nameKey: 'skin_3', price: 500, color: '#FF4500', flame: '#FF4500', eyeColor: '#fff', jetpackColor: '#FF0000', bodyColor: '#110000' },
    { id: 4, nameKey: 'skin_4', price: 1000, color: '#FFD700', flame: '#ffffff', eyeColor: '#fff', jetpackColor: '#DAA520', bodyColor: '#000' }
];

/**
 * LOCALIZATION SYSTEM
 */
const TRANSLATIONS = {
    'en': {
        'title': 'CYBER CAT:<br>FLIGHT',
        'tap': 'TAP TO JUMP',
        'start': 'START MISSION',
        'paused': 'SYSTEM<br>PAUSED',
        'resume': 'RESUME',
        'failed': 'MISSION<br>FAILED',
        'score_label': 'SCORE',
        'best_label': 'BEST:',
        'retry': 'RETRY',
        'revive_btn': 'üì∫ REVIVE <span class="ad-hint">(Ad)</span>',
        'settings_title': 'SETTINGS',
        'lang_label': 'LANGUAGE',
        'back': 'BACK',
        'menu_btn': 'MENU',
        'shop': 'SHOP',
        'shop_title': 'ARMORY',
        'select': 'SELECT',
        'selected': 'EQUIPPED',
        'buy': 'BUY',
        'credits': 'CREDITS',
        'free_credits': 'üì∫ AD: +100 CREDITS',
        'skin_0': 'CYBER CAT',
        'skin_1': 'NEON CAT',
        'skin_2': 'WHITE CAT',
        'skin_3': 'INFERNO CAT',
        'skin_4': 'GOLDEN CAT'
    },
    'ru': {
        'title': '–ö–ò–ë–ï–† –ö–û–¢:<br>–ü–û–õ–Å–¢',
        'tap': '–ù–ê–ñ–ú–ò –î–õ–Ø –ü–†–´–ñ–ö–ê',
        'start': '–ù–ê–ß–ê–¢–¨',
        'paused': '–°–ò–°–¢–ï–ú–ê<br>–ù–ê –ü–ê–£–ó–ï',
        'resume': '–ü–†–û–î–û–õ–ñ–ò–¢–¨',
        'failed': '–ú–ò–°–°–ò–Ø<br>–ü–†–û–í–ê–õ–ï–ù–ê',
        'score_label': '–°–ß–ï–¢',
        'best_label': '–†–ï–ö–û–†–î:',
        'retry': '–ó–ê–ù–û–í–û',
        'revive_btn': 'üì∫ –°–ü–ê–°–¢–ò <span class="ad-hint">(–†–µ–∫–ª–∞–º–∞)</span>',
        'settings_title': '–ù–ê–°–¢–†–û–ô–ö–ò',
        'lang_label': '–Ø–ó–´–ö',
        'back': '–ù–ê–ó–ê–î',
        'menu_btn': '–ú–ï–ù–Æ',
        'shop': '–ú–ê–ì–ê–ó–ò–ù',
        'shop_title': '–ú–ê–ì–ê–ó–ò–ù',
        'select': '–í–´–ë–†–ê–¢–¨',
        'selected': '–í–´–ë–†–ê–ù–û',
        'buy': '–ö–£–ü–ò–¢–¨',
        'credits': '–ö–†–ï–î–ò–¢–´',
        'free_credits': 'üì∫ –†–ï–ö–õ–ê–ú–ê: +100',
        'skin_0': '–ö–ò–ë–ï–† –ö–û–¢',
        'skin_1': '–ù–ï–û–ù–û–í–ê–Ø –ö–û–®–ö–ê',
        'skin_2': '–ë–ï–õ–´–ô –ö–û–¢',
        'skin_3': '–ò–ù–§–ï–†–ù–û –ö–û–¢',
        'skin_4': '–ó–û–õ–û–¢–û–ô –ö–û–¢'
    }
};

class LanguageManager {
    constructor() {
        this.currentLang = 'en';
        this.init();
    }

    init() {
        if (window.ysdk && window.ysdk.environment && window.ysdk.environment.i18n) {
            this.currentLang = window.ysdk.environment.i18n.lang;
        } else {
            const userLang = navigator.language || navigator.userLanguage; 
            if (userLang) {
                this.currentLang = userLang.substr(0, 2);
            }
        }

        const isRu = ['ru', 'be', 'kk', 'uk', 'uz'].some(code => this.currentLang === code);
        this.currentLang = isRu ? 'ru' : 'en';

        this.updateTexts();
    }

    setLanguage(lang) {
        if (TRANSLATIONS[lang]) {
            this.currentLang = lang;
            this.updateTexts();
            this.updateButtons();
        }
    }

    updateButtons() {
        const btnEn = document.getElementById('btn-lang-en');
        const btnRu = document.getElementById('btn-lang-ru');
        
        if (this.currentLang === 'en') {
            btnEn.classList.add('active');
            btnRu.classList.remove('active');
        } else {
            btnEn.classList.remove('active');
            btnRu.classList.add('active');
        }
    }

    updateTexts() {
        const t = TRANSLATIONS[this.currentLang];
        
        const setText = (id, text) => {
            const el = document.getElementById(id);
            if (el) el.innerHTML = text;
        };

        setText('txt-title', t.title);
        setText('txt-tap', t.tap);
        setText('btn-start', t.start);
        setText('btn-shop-open', t.shop);
        setText('txt-shop-title', t.shop_title);
        setText('txt-paused', t.paused);
        setText('btn-resume', t.resume);
        setText('txt-failed', t.failed);
        setText('txt-score-label', t.score_label);
        setText('txt-best-label', t.best_label);
        setText('btn-restart', t.retry);
        setText('btn-revive', t.revive_btn);
        setText('txt-settings-title', t.settings_title);
        setText('txt-lang-label', t.lang_label);
        setText('btn-settings-back', t.back);
        setText('btn-shop-back', t.back);
        setText('btn-shop-free-credits', t.free_credits);
        setText('btn-pause-menu', t.menu_btn);
        setText('btn-gameover-menu', t.menu_btn);
    }
    
    get(key) {
        return TRANSLATIONS[this.currentLang][key] || key;
    }
}

/**
 * OPTIMIZED AUDIO SYSTEM WITH THROTTLING
 */
class SoundManager {
    constructor() {
        this.ctx = null;
        this.muted = false;
        this.initialized = false;
        
        // Throttling –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –ª–∞–≥–æ–≤
        this.lastJumpTime = 0;
        this.lastScoreTime = 0;
        this.lastClickTime = 0;
        this.jumpThrottle = 50;   // –º—Å –º–µ–∂–¥—É –∑–≤—É–∫–∞–º–∏ –ø—Ä—ã–∂–∫–∞
        this.scoreThrottle = 80;  // –º—Å –º–µ–∂–¥—É –∑–≤—É–∫–∞–º–∏ –æ—á–∫–æ–≤
        this.clickThrottle = 30;  // –º—Å –º–µ–∂–¥—É –∫–ª–∏–∫–∞–º–∏
        
        // –ü—É–ª –æ—Å—Ü–∏–ª–ª—è—Ç–æ—Ä–æ–≤ –¥–ª—è –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
        this.activeOscillators = 0;
        this.maxOscillators = 8;  // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∑–≤—É–∫–æ–≤
    }

    init() {
        if (this.initialized) return;
        try {
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            this.ctx = new AudioContext({ latencyHint: 'interactive' });
            this.initialized = true;
        } catch (e) {
            console.error('Web Audio API not supported');
        }
    }

    toggleMute() {
        this.muted = !this.muted;
        if (!this.muted && this.ctx && this.ctx.state === 'suspended') {
            this.ctx.resume();
        }
        return this.muted;
    }

    suspendAudio() {
        if (this.ctx && this.ctx.state === 'running') {
            this.ctx.suspend();
        }
    }

    resumeAudio() {
        if (this.ctx && this.ctx.state === 'suspended' && !this.muted) {
            this.ctx.resume();
        }
    }

    _ready() {
        if (!this.initialized) this.init();
        if (!this.ctx) return false;
        if (this.muted) return false;
        if (this.activeOscillators >= this.maxOscillators) return false;
        if (this.ctx.state === 'suspended') this.ctx.resume();
        return true;
    }

    _canPlay(lastTime, throttle) {
        const now = performance.now();
        return (now - lastTime) >= throttle;
    }

    playJump() {
        if (!this._canPlay(this.lastJumpTime, this.jumpThrottle)) return;
        if (!this._ready()) return;
        
        this.lastJumpTime = performance.now();
        this.activeOscillators++;

        const t = this.ctx.currentTime;
        const osc = this.ctx.createOscillator();
        const gain = this.ctx.createGain();

        osc.connect(gain);
        gain.connect(this.ctx.destination);

        osc.type = 'square';
        osc.frequency.setValueAtTime(150, t);
        osc.frequency.exponentialRampToValueAtTime(400, t + 0.05);

        gain.gain.setValueAtTime(0.08, t);
        gain.gain.exponentialRampToValueAtTime(0.001, t + 0.05);

        osc.onended = () => { this.activeOscillators--; };
        osc.start(t);
        osc.stop(t + 0.05);
    }

    playScore() {
        if (!this._canPlay(this.lastScoreTime, this.scoreThrottle)) return;
        if (!this._ready()) return;
        
        this.lastScoreTime = performance.now();
        this.activeOscillators++;
        
        const t = this.ctx.currentTime;
        const osc = this.ctx.createOscillator();
        const gain = this.ctx.createGain();

        osc.connect(gain);
        gain.connect(this.ctx.destination);

        osc.type = 'sine';
        osc.frequency.setValueAtTime(800, t);
        osc.frequency.exponentialRampToValueAtTime(1500, t + 0.08);

        gain.gain.setValueAtTime(0.04, t);
        gain.gain.linearRampToValueAtTime(0.0, t + 0.08);

        osc.onended = () => { this.activeOscillators--; };
        osc.start(t);
        osc.stop(t + 0.08);
    }

    playCrash() {
        if (!this._ready()) return;
        
        this.activeOscillators++;
        const t = this.ctx.currentTime;
        const osc = this.ctx.createOscillator();
        const gain = this.ctx.createGain();

        osc.connect(gain);
        gain.connect(this.ctx.destination);

        osc.type = 'sawtooth';
        osc.frequency.setValueAtTime(100, t);
        osc.frequency.exponentialRampToValueAtTime(10, t + 0.3);

        gain.gain.setValueAtTime(0.08, t);
        gain.gain.exponentialRampToValueAtTime(0.001, t + 0.3);

        osc.onended = () => { this.activeOscillators--; };
        osc.start(t);
        osc.stop(t + 0.3);
    }

    playUiClick() {
        if (!this._canPlay(this.lastClickTime, this.clickThrottle)) return;
        if (!this._ready()) return;
        
        this.lastClickTime = performance.now();
        this.activeOscillators++;
        
        const t = this.ctx.currentTime;
        const osc = this.ctx.createOscillator();
        const gain = this.ctx.createGain();
        osc.connect(gain);
        gain.connect(this.ctx.destination);
        osc.type = 'sine';
        osc.frequency.setValueAtTime(1200, t);
        gain.gain.setValueAtTime(0.04, t);
        gain.gain.exponentialRampToValueAtTime(0.001, t + 0.08);
        osc.onended = () => { this.activeOscillators--; };
        osc.start(t);
        osc.stop(t + 0.08);
    }

    playUiBack() {
        if (!this._ready()) return;
        this.activeOscillators++;
        const t = this.ctx.currentTime;
        const osc = this.ctx.createOscillator();
        const gain = this.ctx.createGain();
        osc.connect(gain);
        gain.connect(this.ctx.destination);
        osc.type = 'sine';
        osc.frequency.setValueAtTime(400, t);
        gain.gain.setValueAtTime(0.04, t);
        gain.gain.exponentialRampToValueAtTime(0.001, t + 0.12);
        osc.onended = () => { this.activeOscillators--; };
        osc.start(t);
        osc.stop(t + 0.12);
    }

    playShopSuccess() {
        if (!this._ready()) return;
        
        const t = this.ctx.currentTime;
        [523.25, 659.25, 783.99].forEach((freq, i) => {
            if (this.activeOscillators >= this.maxOscillators) return;
            this.activeOscillators++;
            const osc = this.ctx.createOscillator();
            const gain = this.ctx.createGain();
            osc.connect(gain);
            gain.connect(this.ctx.destination);
            osc.type = 'square';
            osc.frequency.setValueAtTime(freq, t + i * 0.05);
            gain.gain.setValueAtTime(0.04, t + i * 0.05);
            gain.gain.exponentialRampToValueAtTime(0.001, t + i * 0.05 + 0.1);
            osc.onended = () => { this.activeOscillators--; };
            osc.start(t + i * 0.05);
            osc.stop(t + i * 0.05 + 0.1);
        });
    }

    playShopError() {
        if (!this._ready()) return;
        
        this.activeOscillators++;
        const t = this.ctx.currentTime;
        const osc = this.ctx.createOscillator();
        const gain = this.ctx.createGain();
        osc.connect(gain);
        gain.connect(this.ctx.destination);
        osc.type = 'sawtooth';
        osc.frequency.setValueAtTime(150, t);
        osc.frequency.linearRampToValueAtTime(100, t + 0.2);
        gain.gain.setValueAtTime(0.08, t);
        gain.gain.linearRampToValueAtTime(0.0, t + 0.2);
        osc.onended = () => { this.activeOscillators--; };
        osc.start(t);
        osc.stop(t + 0.2);
    }

    playEquip() {
        if (!this._ready()) return;
        
        this.activeOscillators++;
        const t = this.ctx.currentTime;
        const osc = this.ctx.createOscillator();
        const gain = this.ctx.createGain();
        osc.connect(gain);
        gain.connect(this.ctx.destination);
        osc.type = 'triangle';
        osc.frequency.setValueAtTime(800, t);
        osc.frequency.exponentialRampToValueAtTime(100, t + 0.1);
        gain.gain.setValueAtTime(0.08, t);
        gain.gain.exponentialRampToValueAtTime(0.001, t + 0.1);
        osc.onended = () => { this.activeOscillators--; };
        osc.start(t);
        osc.stop(t + 0.1);
    }
}

/**
 * –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø
 */
const CONFIG = {
    logicalWidth: 720,
    gravity: 1900,        
    jumpForce: -620,       
    terminalVelocity: 1000,
    initialSpeed: 350,
    speed: 350,
    speedIncreaseStep: 1.5,
    maxSpeed: 600,
    gapSize: 220, 
    minPipeDistance: 480
};

const STATE = {
    START: 0,
    PLAYING: 1,
    PAUSED: 2,
    GAMEOVER: 3,
    SETTINGS: 4,
    SHOP: 5
};

/**
 * –ö–õ–ê–°–° –ò–ì–†–´
 */
class Game {
    constructor() {
        this.canvas = document.getElementById('gameCanvas');
        this.ctx = this.canvas.getContext('2d');
        this.wrapper = document.getElementById('game-wrapper');

        this.canvas.width = CONFIG.logicalWidth;
        this.canvas.height = 1280;

        this.ui = {
            start: document.getElementById('start-screen'),
            gameover: document.getElementById('gameover-screen'),
            pause: document.getElementById('pause-screen'),
            settings: document.getElementById('settings-screen'),
            shop: document.getElementById('shop-screen'),
            hud: document.getElementById('hud'),
            score: document.getElementById('score-display'),
            finalScore: document.getElementById('final-score'),
            bestScore: document.getElementById('best-score'),
            btnStart: document.getElementById('btn-start'),
            btnShopOpen: document.getElementById('btn-shop-open'),
            btnShopBack: document.getElementById('btn-shop-back'),
            btnShopPrev: document.getElementById('btn-shop-prev'),
            btnShopNext: document.getElementById('btn-shop-next'),
            btnShopSelect: document.getElementById('btn-shop-select'),
            btnShopFreeCredits: document.getElementById('btn-shop-free-credits'),
            shopSkinName: document.getElementById('shop-skin-name'),
            shopCanvas: document.getElementById('shopCanvas'),
            shopCredits: document.getElementById('shop-credits'),
            btnRestart: document.getElementById('btn-restart'),
            btnRevive: document.getElementById('btn-revive'),
            btnResume: document.getElementById('btn-resume'),
            btnPauseMenu: document.getElementById('btn-pause-menu'),
            btnGameOverMenu: document.getElementById('btn-gameover-menu'),
            btnPause: document.getElementById('btn-toggle-pause'),
            btnSound: document.getElementById('btn-toggle-sound'),
            btnSettingsOpen: document.getElementById('btn-settings-open'),
            btnSettingsBack: document.getElementById('btn-settings-back'),
            btnLangEn: document.getElementById('btn-lang-en'),
            btnLangRu: document.getElementById('btn-lang-ru')
        };

        this.langManager = new LanguageManager();
        this.langManager.updateButtons();

        this.sound = new SoundManager();
        this.state = STATE.START;
        
        this.lastTime = 0;
        this.score = 0;
        this.highScore = parseInt(localStorage.getItem('cybercat_highscore')) || 0;
        this.credits = parseInt(localStorage.getItem('cybercat_credits')) || 0;
        this.inventory = JSON.parse(localStorage.getItem('cybercat_inventory')) || [0];
        
        this.hasRevived = false;

        this.selectedSkinId = parseInt(localStorage.getItem('cybercat_skin')) || 0;
        this.browsingSkinIndex = this.selectedSkinId;
        this.shopCtx = this.ui.shopCanvas.getContext('2d');

        this.cat = new Cat(this);
        this.obstacles = [];
        this.background = new Background(this);

        // –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—É–ª —á–∞—Å—Ç–∏—Ü
        this.particlePool = [];
        for(let i = 0; i < 30; i++) {
            this.particlePool.push(new Particle());
        }

        this.initListeners();
        this.resize();
        
        requestAnimationFrame((t) => this.loop(t));
    }

    initListeners() {
        window.addEventListener('resize', () => this.resize());
        
        const unlockAudio = () => {
            this.sound.init();
            this.sound.resumeAudio();
            document.removeEventListener('pointerdown', unlockAudio);
            document.removeEventListener('keydown', unlockAudio);
        };
        document.addEventListener('pointerdown', unlockAudio);
        document.addEventListener('keydown', unlockAudio);

        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                this.sound.suspendAudio();
                if (this.state === STATE.PLAYING) {
                    this.togglePause();
                }
            } else {
                this.sound.resumeAudio();
            }
        });

        this.ui.btnStart.addEventListener('click', (e) => {
            e.preventDefault();
            this.sound.init();
            this.sound.playUiClick();
            this.startGame();
        });
        
        this.ui.btnRestart.addEventListener('click', (e) => {
            e.preventDefault();
            this.sound.playUiClick();
            this.showAdAndRestart();
        });

        this.ui.btnRevive.addEventListener('click', (e) => {
            e.preventDefault();
            this.sound.playUiClick();
            this.showReviveAd();
        });

        this.ui.btnResume.addEventListener('click', (e) => {
            e.preventDefault();
            this.sound.playUiClick();
            this.togglePause();
        });

        this.ui.btnShopOpen.addEventListener('click', (e) => {
            e.preventDefault();
            this.sound.playUiClick();
            this.openShop();
        });
        this.ui.btnShopBack.addEventListener('click', (e) => {
            e.preventDefault();
            this.sound.playUiBack();
            this.closeShop();
        });
        this.ui.btnShopPrev.addEventListener('click', (e) => {
            e.preventDefault();
            this.sound.playUiClick();
            this.changeBrowseSkin(-1);
        });
        this.ui.btnShopNext.addEventListener('click', (e) => {
            e.preventDefault();
            this.sound.playUiClick();
            this.changeBrowseSkin(1);
        });
        this.ui.btnShopSelect.addEventListener('click', (e) => {
            e.preventDefault();
            this.handleShopAction();
        });
        this.ui.btnShopFreeCredits.addEventListener('click', (e) => {
             e.preventDefault();
             this.sound.playUiClick();
             this.watchAdForCredits();
        });

        const menuHandler = (e) => {
            e.preventDefault();
            this.sound.playUiBack();
            
            if (window.ysdk) {
                this.sound.suspendAudio();
                window.ysdk.adv.showFullscreenAdv({
                    callbacks: {
                        onClose: (wasShown) => {
                            this.sound.resumeAudio();
                            this.exitToMenu();
                        },
                        onError: (error) => {
                            this.sound.resumeAudio();
                            this.exitToMenu();
                        }
                    }
                });
            } else {
                this.exitToMenu();
            }
        };
        this.ui.btnPauseMenu.addEventListener('click', menuHandler);
        this.ui.btnGameOverMenu.addEventListener('click', menuHandler);

        this.ui.btnPause.addEventListener('click', (e) => {
            e.stopPropagation();
            this.sound.playUiClick();
            this.togglePause();
        });

        this.ui.btnSound.addEventListener('click', (e) => {
            e.stopPropagation();
            const isMuted = this.sound.toggleMute();
            if (!isMuted) this.sound.playUiClick();
            this.ui.btnSound.innerText = isMuted ? 'üîá' : 'üîä';
            this.ui.btnSound.classList.toggle('muted', isMuted);
        });

        this.ui.btnSettingsOpen.addEventListener('click', (e) => {
            e.stopPropagation();
            this.sound.playUiClick();
            this.openSettings();
        });

        this.ui.btnSettingsBack.addEventListener('click', (e) => {
            e.stopPropagation();
            this.sound.playUiBack();
            this.closeSettings();
        });

        this.ui.btnLangEn.addEventListener('click', (e) => {
            e.stopPropagation();
            this.sound.playUiClick();
            this.langManager.setLanguage('en');
            this.updateShopUI();
        });

        this.ui.btnLangRu.addEventListener('click', (e) => {
            e.stopPropagation();
            this.sound.playUiClick();
            this.langManager.setLanguage('ru');
            this.updateShopUI();
        });

        this.wrapper.addEventListener('pointerdown', (e) => {
            if (e.target.tagName === 'BUTTON') return;
            if (this.state === STATE.PLAYING) {
                this.cat.jump();
            }
        });

        window.addEventListener('keydown', (e) => {
            if (e.code === 'Space' || e.code === 'ArrowUp') {
                if (this.state === STATE.PLAYING) this.cat.jump();
            }
            if (e.code === 'Escape') {
                if (this.state === STATE.PLAYING || this.state === STATE.PAUSED) {
                    this.togglePause();
                }
            }
        });
    }

    spawnParticle(x, y) {
        const p = this.particlePool.find(p => !p.active);
        if (p) p.activate(x, y, this.selectedSkinId);
    }

    resize() {
        const winW = window.innerWidth;
        const winH = window.innerHeight;
        const effectiveWidth = Math.min(winW, winH * 0.6); 
        const aspect = effectiveWidth / winH;
        
        this.canvas.width = CONFIG.logicalWidth;
        this.canvas.height = CONFIG.logicalWidth / aspect;
    }

    openShop() {
        this.state = STATE.SHOP;
        this.browsingSkinIndex = this.selectedSkinId;
        this.ui.start.classList.add('hidden');
        this.ui.shop.classList.remove('hidden');
        this.ui.btnSettingsOpen.style.display = 'none';
        this.updateShopUI();
    }

    closeShop() {
        this.state = STATE.START;
        this.ui.shop.classList.add('hidden');
        this.ui.start.classList.remove('hidden');
        this.ui.btnSettingsOpen.style.display = 'block';
    }

    changeBrowseSkin(delta) {
        let newIndex = this.browsingSkinIndex + delta;
        if (newIndex < 0) newIndex = SKINS.length - 1;
        if (newIndex >= SKINS.length) newIndex = 0;
        this.browsingSkinIndex = newIndex;
        this.updateShopUI();
    }

    handleShopAction() {
        const skin = SKINS[this.browsingSkinIndex];
        const isOwned = this.inventory.includes(skin.id);

        if (isOwned) {
            this.selectedSkinId = this.browsingSkinIndex;
            localStorage.setItem('cybercat_skin', this.selectedSkinId);
            this.cat.updateSkin();
            this.sound.playEquip();
            this.updateShopUI();
        } else {
            if (this.credits >= skin.price) {
                this.credits -= skin.price;
                this.inventory.push(skin.id);
                this.selectedSkinId = skin.id;
                
                localStorage.setItem('cybercat_credits', this.credits);
                localStorage.setItem('cybercat_inventory', JSON.stringify(this.inventory));
                localStorage.setItem('cybercat_skin', this.selectedSkinId);
                
                this.sound.playShopSuccess();
                this.cat.updateSkin();
                this.updateShopUI();
            } else {
                this.sound.playShopError();
                this.ui.btnShopSelect.classList.add('btn-locked');
                setTimeout(() => {
                    this.updateShopUI();
                }, 300);
            }
        }
    }
    
    watchAdForCredits() {
        let rewardGranted = false;
        const finishAd = () => {
            this.sound.resumeAudio();
            if (rewardGranted) {
                 this.credits += 100;
                 localStorage.setItem('cybercat_credits', this.credits);
                 this.sound.playShopSuccess();
                 this.updateShopUI();
            }
        };

        if (window.ysdk) {
            this.sound.suspendAudio();
            window.ysdk.adv.showRewardedVideo({
                callbacks: {
                    onOpen: () => {},
                    onRewarded: () => { rewardGranted = true; },
                    onClose: () => { finishAd(); },
                    onError: (e) => { finishAd(); }
                }
            });
        } else {
            rewardGranted = true;
            finishAd();
        }
    }

    updateShopUI() {
        const skin = SKINS[this.browsingSkinIndex];
        this.ui.shopSkinName.innerText = this.langManager.get(skin.nameKey);
        this.ui.shopCredits.innerText = `${this.langManager.get('credits')}: ${this.credits}`;
        this.ui.btnShopFreeCredits.innerHTML = this.langManager.get('free_credits');
        
        const shopTitle = document.getElementById('txt-shop-title');
        if (shopTitle) shopTitle.innerText = this.langManager.get('shop_title');

        const isOwned = this.inventory.includes(skin.id);
        const isSelected = this.selectedSkinId === skin.id;

        this.ui.btnShopSelect.classList.remove('btn-equipped', 'btn-buy', 'btn-locked');

        if (isOwned) {
            if (isSelected) {
                this.ui.btnShopSelect.innerText = this.langManager.get('selected');
                this.ui.btnShopSelect.classList.add('btn-equipped');
            } else {
                this.ui.btnShopSelect.innerText = this.langManager.get('select');
            }
        } else {
            this.ui.btnShopSelect.innerText = `${this.langManager.get('buy')} (${skin.price})`;
            if (this.credits >= skin.price) {
                this.ui.btnShopSelect.classList.add('btn-buy');
            } else {
                this.ui.btnShopSelect.classList.add('btn-locked');
            }
        }
        
        this.drawShopPreview();
    }

    drawShopPreview() {
        const ctx = this.shopCtx;
        const cw = this.ui.shopCanvas.width;
        const ch = this.ui.shopCanvas.height;
        
        ctx.clearRect(0, 0, cw, ch);
        ctx.fillStyle = "#111";
        ctx.fillRect(0, 0, cw, ch);
        
        ctx.save();
        ctx.translate(cw / 2, ch / 2);
        drawCatVisuals(ctx, 50, 40, this.browsingSkinIndex, null); 
        ctx.restore();
    }

    openSettings() {
        if (this.state === STATE.START) {
            this.previousState = STATE.START;
        } else if (this.state === STATE.PAUSED) {
            this.previousState = STATE.PAUSED;
        } else {
            this.previousState = STATE.START; 
        }

        this.state = STATE.SETTINGS;
        
        this.ui.start.classList.add('hidden');
        this.ui.pause.classList.add('hidden');
        this.ui.gameover.classList.add('hidden');
        
        this.ui.settings.classList.remove('hidden');
        this.ui.btnSettingsOpen.style.display = 'none';
        this.ui.btnPause.style.display = 'none';
    }

    closeSettings() {
        if (this.state === STATE.SETTINGS) {
            this.state = this.previousState;
            this.ui.settings.classList.add('hidden');
            
            if (this.state === STATE.START) {
                this.ui.start.classList.remove('hidden');
                this.ui.btnSettingsOpen.style.display = 'block';
            } else if (this.state === STATE.PAUSED) {
                this.ui.pause.classList.remove('hidden');
            }
        }
    }

    exitToMenu() {
        this.state = STATE.START;
        
        this.ui.settings.classList.add('hidden');
        this.ui.pause.classList.add('hidden');
        this.ui.gameover.classList.add('hidden');
        this.ui.hud.classList.add('hidden');
        
        this.ui.start.classList.remove('hidden');
        this.ui.btnSettingsOpen.style.display = 'block';
        this.ui.btnPause.style.display = 'none';

        this.cat.reset();
        this.obstacles = [];
        this.particlePool.forEach(p => p.active = false);
        this.score = 0;
        CONFIG.speed = CONFIG.initialSpeed;
        this.hasRevived = false;
        
        this.lastTime = performance.now();
    }

    startGame() {
        this.state = STATE.PLAYING;
        this.ui.start.classList.add('hidden');
        this.ui.settings.classList.add('hidden');
        this.ui.hud.classList.remove('hidden');
        this.ui.btnPause.style.display = 'flex';
        this.ui.btnSettingsOpen.style.display = 'none';
        
        CONFIG.speed = CONFIG.initialSpeed;
        this.hasRevived = false;
        
        this.cat.updateSkin();
        this.cat.reset(); 
        this.cat.jump();
        this.score = 0;
        this.updateScoreUI();
        this.lastTime = performance.now();
    }

    showAdAndRestart() {
        const finishAd = () => {
            this.sound.resumeAudio();
            this.resetGame();
        };

        if (window.ysdk) {
            this.sound.suspendAudio();
            window.ysdk.adv.showFullscreenAdv({
                callbacks: {
                    onClose: function(wasShown) { finishAd(); },
                    onError: function(error) { finishAd(); }
                }
            });
        } else {
            finishAd();
        }
    }

    showReviveAd() {
        let rewardGranted = false;
        const finishRevive = () => {
            this.sound.resumeAudio();
            if (rewardGranted) {
                this.reviveHero();
            }
        };

        if (window.ysdk) {
            this.sound.suspendAudio();
            window.ysdk.adv.showRewardedVideo({
                callbacks: {
                    onOpen: () => {},
                    onRewarded: () => { rewardGranted = true; },
                    onClose: () => { finishRevive(); },
                    onError: (e) => { finishRevive(); }
                }
            });
        } else {
            rewardGranted = true; 
            finishRevive();
        }
    }

    reviveHero() {
        this.hasRevived = true;
        this.state = STATE.PLAYING;
        
        this.ui.gameover.classList.add('hidden');
        this.ui.hud.classList.remove('hidden');
        this.ui.btnPause.style.display = 'flex';

        this.cat.y = this.canvas.height / 2;
        this.cat.velocity = 0;
        this.cat.rotation = 0;
        this.obstacles = [];

        this.lastTime = performance.now();
        this.cat.jump();
    }

    resetGame() {
        this.cat = new Cat(this);
        this.obstacles = [];
        this.particlePool.forEach(p => p.active = false);
        this.score = 0;
        this.hasRevived = false;
        
        CONFIG.speed = CONFIG.initialSpeed;
        
        this.state = STATE.PLAYING;
        this.ui.gameover.classList.add('hidden');
        this.ui.hud.classList.remove('hidden');
        this.ui.btnPause.style.display = 'flex';
        this.cat.jump();
        this.updateScoreUI();
        this.lastTime = performance.now();
    }

    togglePause() {
        if (this.state === STATE.PLAYING) {
            this.state = STATE.PAUSED;
            this.ui.pause.classList.remove('hidden');
            this.ui.btnPause.style.display = 'none';
        } else if (this.state === STATE.PAUSED) {
            this.state = STATE.PLAYING;
            this.ui.pause.classList.add('hidden');
            this.ui.btnPause.style.display = 'flex';
            this.lastTime = performance.now();
        }
    }

    gameOver() {
        this.ui.gameover.classList.remove('hidden');
        this.state = STATE.GAMEOVER;
        
        this.sound.playCrash();
        
        this.credits += this.score;
        localStorage.setItem('cybercat_credits', this.credits);
        
        if (this.score > this.highScore) {
            this.highScore = this.score;
            localStorage.setItem('cybercat_highscore', this.highScore);
        }

        this.ui.hud.classList.add('hidden');
        this.ui.btnPause.style.display = 'none';
        this.ui.finalScore.innerText = this.score;
        this.ui.bestScore.innerText = this.highScore;

        this.ui.btnRevive.style.display = this.hasRevived ? 'none' : 'flex';
    }

    updateScoreUI() {
        this.ui.score.innerText = this.score;
    }

    loop(timestamp) {
        if (!this.lastTime) this.lastTime = timestamp;
        let dt = (timestamp - this.lastTime) / 1000;
        this.lastTime = timestamp;

        // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ dt –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏
        if (dt > 0.1) dt = 0.1;

        this.update(dt);
        this.draw();
        
        requestAnimationFrame((t) => this.loop(t));
    }

    update(dt) {
        if (this.state === STATE.SHOP) {
            return;
        }

        if (this.state === STATE.PAUSED || this.state === STATE.SETTINGS) return;

        this.background.update(dt);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã–µ —á–∞—Å—Ç–∏—Ü—ã
        for (let i = 0; i < this.particlePool.length; i++) {
            if (this.particlePool[i].active) {
                this.particlePool[i].update(dt);
            }
        }

        if (this.state === STATE.PLAYING) {
            this.cat.update(dt);
            
            const speedRatio = (CONFIG.speed - CONFIG.initialSpeed) / (CONFIG.maxSpeed - CONFIG.initialSpeed);
            const dynamicMinDistance = CONFIG.minPipeDistance - (speedRatio * 50);

            if (this.obstacles.length === 0) {
                this.obstacles.push(new Obstacle(this));
            } else {
                const lastObs = this.obstacles[this.obstacles.length - 1];
                if (CONFIG.logicalWidth - lastObs.x >= dynamicMinDistance) {
                    this.obstacles.push(new Obstacle(this, lastObs));
                }
            }

            const hitPaddingX = this.cat.w * 0.2;
            const hitPaddingY = this.cat.h * 0.2;
            
            const catHitL = this.cat.x + hitPaddingX;
            const catHitR = this.cat.x + this.cat.w - hitPaddingX;
            const catHitT = this.cat.y + hitPaddingY;
            const catHitB = this.cat.y + this.cat.h - hitPaddingY;

            for (let i = this.obstacles.length - 1; i >= 0; i--) {
                const obs = this.obstacles[i];
                obs.update(dt);
                
                if (!obs.passed && this.cat.x > obs.x + obs.w) {
                    obs.passed = true;
                    this.score++;
                    this.updateScoreUI();
                    this.sound.playScore();
                    
                    CONFIG.speed = Math.min(CONFIG.maxSpeed, CONFIG.speed + CONFIG.speedIncreaseStep);
                }

                if (obs.x + obs.w < 0) {
                    this.obstacles.splice(i, 1);
                    continue;
                }

                if (
                    catHitR > obs.x &&
                    catHitL < obs.x + obs.w &&
                    (catHitT < obs.topHeight || catHitB > obs.bottomY)
                ) {
                    this.gameOver();
                }
            }

            if (this.cat.y + this.cat.h >= this.canvas.height || this.cat.y <= 0) {
                this.gameOver();
            }

        } else if (this.state === STATE.GAMEOVER) {
            if (this.cat.y + this.cat.h < this.canvas.height) {
                this.cat.velocity += CONFIG.gravity * dt;
                this.cat.y += this.cat.velocity * dt;
            }
        }
    }

    draw() {
        if (this.state === STATE.SHOP) return;

        const ctx = this.ctx;
        ctx.fillStyle = "#0d001a";
        ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);

        this.background.draw(ctx);
        
        for (let i = 0; i < this.obstacles.length; i++) {
            this.obstacles[i].draw(ctx);
        }
        
        for (let i = 0; i < this.particlePool.length; i++) {
            if (this.particlePool[i].active) {
                this.particlePool[i].draw(ctx);
            }
        }
        
        this.cat.draw(ctx);

        if (this.state === STATE.PAUSED || this.state === STATE.SETTINGS) {
            ctx.fillStyle = "rgba(0,0,0,0.3)";
            ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
        }
    }
}

/**
 * VISUAL HELPER FUNCTION
 */
function drawCatVisuals(ctx, w, h, skinId, velocity) {
    const skin = SKINS[skinId];
    
    let fillColor = skin.bodyColor || "#000";
    let strokeColor = skin.color;
    
    if (skinId === 4) {
        let grd = ctx.createLinearGradient(-w/2, -h/2, w/2, h/2);
        grd.addColorStop(0, "#FFD700"); 
        grd.addColorStop(1, "#FFA500"); 
        fillColor = grd;
        strokeColor = "#FFA500";
    }

    // Flame
    if (velocity === null || velocity < 0) {
        const flameLength = 20 + Math.random() * 15;
        ctx.fillStyle = skin.flame;
        ctx.shadowBlur = 15;
        ctx.shadowColor = skin.flame;
        
        ctx.beginPath();
        ctx.moveTo(-w/2 - 10, -5); 
        ctx.lineTo(-w/2 - 10 - flameLength, 5);
        ctx.lineTo(-w/2 - 10, 15);
        ctx.fill();
        ctx.shadowBlur = 0; 
    }

    // Jetpack
    ctx.fillStyle = skin.jetpackColor || '#555';
    ctx.fillRect(-w/2 - 10, -5, 10, 20);

    // Body
    ctx.shadowBlur = skinId === 4 ? 20 : 12; 
    ctx.shadowColor = skin.color;
    
    ctx.strokeStyle = strokeColor;
    ctx.lineWidth = 3;
    ctx.fillStyle = fillColor;

    ctx.fillRect(-w/2, -h/2, w, h);
    ctx.strokeRect(-w/2, -h/2, w, h);

    // Ears
    if (skinId !== 4) {
        ctx.lineWidth = 2;
        ctx.strokeStyle = strokeColor; 
        let yTop = -15;

        ctx.beginPath();
        ctx.moveTo(-10, -h/2);
        ctx.lineTo(-20, -h/2 + yTop); 
        ctx.lineTo(0, -h/2);
        ctx.moveTo(5, -h/2);
        ctx.lineTo(15, -h/2 + yTop);
        ctx.lineTo(25, -h/2);
        ctx.stroke();
    }

    // Eye
    ctx.shadowBlur = 0;
    ctx.fillStyle = skin.eyeColor;
    ctx.fillRect(8, -12, 8, 8);

    // Special details
    if (skinId === 3) {
         ctx.strokeStyle = "#000";
         ctx.lineWidth = 2;
         ctx.beginPath();
         ctx.moveTo(6, -16);
         ctx.lineTo(18, -10);
         ctx.stroke();
    } else if (skinId === 4) {
         ctx.strokeStyle = "#FFD700";
         ctx.lineWidth = 2;
         ctx.beginPath();
         ctx.moveTo(-10, -h/2);
         ctx.lineTo(-15, -h/2 - 15);
         ctx.lineTo(-5, -h/2 - 5);
         ctx.lineTo(0, -h/2 - 20);
         ctx.lineTo(5, -h/2 - 5);
         ctx.lineTo(15, -h/2 - 15);
         ctx.lineTo(10, -h/2);
         ctx.stroke();
    }
    
    ctx.shadowBlur = 0;
}

class Cat {
    constructor(game) {
        this.game = game;
        this.w = 50;
        this.h = 40;
        this.skin = SKINS[game.selectedSkinId];
        this.reset();
    }

    updateSkin() {
        this.skin = SKINS[this.game.selectedSkinId];
    }

    reset() {
        this.x = this.game.canvas.width / 2 - 100;
        this.y = this.game.canvas.height / 2;
        this.velocity = 0;
        this.rotation = 0;
        this.timer = 0;
    }

    jump() {
        this.velocity = CONFIG.jumpForce;
        this.rotation = -20; 
        
        this.game.sound.playJump();
        for(let i = 0; i < 3; i++) {
            this.game.spawnParticle(this.x, this.y + this.h/2);
        }
    }

    update(dt) {
        this.velocity += CONFIG.gravity * dt;
        
        if (this.velocity > CONFIG.terminalVelocity) {
            this.velocity = CONFIG.terminalVelocity;
        }

        this.y += this.velocity * dt;

        if (this.velocity < 0) {
            this.rotation = Math.max(-20, this.rotation - 600 * dt);
        } else {
            this.rotation = Math.min(45, this.rotation + 200 * dt);
        }

        this.timer += dt;
        if (this.timer > 0.08) { 
            this.game.spawnParticle(this.x, this.y + this.h/2 + 5);
            this.timer = 0;
        }
    }

    draw(ctx) {
        ctx.save();
        ctx.translate(~~(this.x + this.w/2), ~~(this.y + this.h/2));
        ctx.rotate(this.rotation * Math.PI / 180);
        drawCatVisuals(ctx, this.w, this.h, this.skin.id, this.velocity);
        ctx.restore();
    }
}

class Obstacle {
    constructor(game, lastObstacle = null) {
        this.game = game;
        this.w = 70;
        this.x = game.canvas.width;
        this.passed = false;
        
        const minHeight = 150;
        const maxTop = game.canvas.height - CONFIG.gapSize - minHeight;
        
        let minSafe = minHeight;
        let maxSafe = maxTop;

        if (lastObstacle) {
            const maxDelta = 400; 
            minSafe = Math.max(minHeight, lastObstacle.topHeight - maxDelta);
            maxSafe = Math.min(maxTop, lastObstacle.topHeight + maxDelta);
        }

        this.topHeight = Math.floor(Math.random() * (maxSafe - minSafe + 1) + minSafe);
        this.bottomY = this.topHeight + CONFIG.gapSize;
    }
    
    update(dt) { 
        this.x -= CONFIG.speed * dt; 
    }
    
    draw(ctx) {
        const x = ~~this.x;
        const w = ~~this.w;
        const th = ~~this.topHeight;
        const by = ~~this.bottomY;
        const gh = ~~(this.game.canvas.height - this.bottomY);

        // Simplified glow
        ctx.lineWidth = 15;
        ctx.strokeStyle = "rgba(0, 255, 0, 0.25)";
        
        ctx.beginPath();
        ctx.rect(x, -5, w, th + 5);
        ctx.stroke();

        ctx.beginPath();
        ctx.rect(x, by, w, gh + 5);
        ctx.stroke();

        // Main body
        ctx.fillStyle = "#001a00";
        ctx.strokeStyle = "#0f0";
        ctx.lineWidth = 4;
        
        ctx.fillRect(x, 0, w, th);
        ctx.strokeRect(x, -5, w, th + 5);
        
        ctx.fillStyle = "#0f0";
        ctx.fillRect(x + 10, th - 40, w - 20, 10);
        
        ctx.fillStyle = "#001a00";
        ctx.fillRect(x, by, w, gh);
        ctx.strokeRect(x, by, w, gh + 5);
        
        ctx.fillStyle = "#0f0";
        ctx.fillRect(x + 10, by + 30, w - 20, 10);
    }
}

class Particle {
    constructor() {
        this.active = false;
    }

    activate(x, y, skinId) {
        this.x = x;
        this.y = y;
        this.life = 1.0;
        this.size = Math.random() * 6 + 3;
        
        this.vx = (Math.random() - 0.5) * 200 - 200; 
        this.vy = (Math.random() - 0.5) * 200;
        this.decay = 3.0;

        const skin = SKINS[skinId];
        this.color = skin.flame;
        
        this.active = true;
    }
    
    update(dt) {
        this.x += this.vx * dt;
        this.y += this.vy * dt;
        this.life -= this.decay * dt; 
        this.size *= (1 - 2.5 * dt);
        if (this.life <= 0 || this.size < 1) this.active = false;
    }
    
    draw(ctx) {
        ctx.globalAlpha = Math.max(0, this.life);
        ctx.fillStyle = this.color;
        ctx.fillRect(~~this.x, ~~this.y, ~~this.size, ~~this.size);
        ctx.globalAlpha = 1.0;
    }
}

class Background {
    constructor(game) {
        this.game = game;
        this.bgX = 0;
        this.buildings = [];
        for(let i = 0; i < 15; i++) {
            this.buildings.push({
                x: i * 100,
                w: 60 + Math.random() * 40,
                h: 200 + Math.random() * 500,
                color: `rgba(20, 0, 50, ${0.3 + Math.random() * 0.4})`
            });
        }
    }
    
    update(dt) {
        if (this.game.state === STATE.PLAYING) {
            this.bgX -= (CONFIG.speed * 0.08) * dt; 
            if (this.bgX <= -CONFIG.logicalWidth) this.bgX = 0;
        }
    }
    
    draw(ctx) {
        // Simplified grid
        ctx.strokeStyle = "rgba(100, 0, 255, 0.08)";
        ctx.lineWidth = 1;
        const gridSize = 100;
        const offset = ~~this.bgX % gridSize;
        
        for (let x = offset; x < CONFIG.logicalWidth; x += gridSize) {
            ctx.beginPath();
            ctx.moveTo(~~x, 0);
            ctx.lineTo(~~x, this.game.canvas.height);
            ctx.stroke();
        }
        for (let y = 0; y < this.game.canvas.height; y += gridSize) {
            ctx.beginPath();
            ctx.moveTo(0, ~~y);
            ctx.lineTo(CONFIG.logicalWidth, ~~y);
            ctx.stroke();
        }
        
        // Buildings
        ctx.save();
        ctx.translate(~~this.bgX, 0);
        for(let j = 0; j < 2; j++) {
            const shift = j * 1500;
            for (let i = 0; i < this.buildings.length; i++) {
                const b = this.buildings[i];
                ctx.fillStyle = b.color;
                ctx.fillRect(~~(b.x + shift), ~~(this.game.canvas.height - b.h), ~~b.w, ~~b.h);
            }
        }
        ctx.restore();
    }
}

/**
 * INITIALIZATION
 */
let gameInstance = null;

function initYandex() {
    YaGames.init().then(ysdk_instance => {
        console.log('Yandex SDK Initialized');
        ysdk = ysdk_instance;
        
        if (ysdk.deviceInfo.type === 'mobile' || ysdk.deviceInfo.type === 'tablet') {
            document.body.classList.add('mobile-device');
        }
        
        ysdk.features.LoadingAPI.ready();

        if (gameInstance && gameInstance.langManager) {
            gameInstance.langManager.init();
            gameInstance.langManager.updateButtons();
        }
    }).catch(console.error);
}

window.onload = () => {
    gameInstance = new Game();
    initYandex();
};
</script>
</body>
</html>
